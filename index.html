<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Lofi Girl - Premium Radio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --bg-deep: #050505;
            --glass-panel: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --dynamic-color: #e0aa3e; /* Updates via JS */
            --radius-xl: 24px;
            --radius-lg: 16px;
            --sidebar-width: 260px;
            --app-height: 100dvh; /* iOS Fix */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: var(--app-height);
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- DYNAMIC BACKGROUND --- */
        .ambient-glow {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 50% 50%, var(--dynamic-color), transparent 70%);
            opacity: 0.15;
            z-index: 0;
            transition: background 3s ease; /* Slower transition */
            pointer-events: none;
        }
        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwMDAwIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wOCkiLz4KPC9zdmc+');
            opacity: 0.6;
            z-index: 1;
            pointer-events: none;
        }

        /* --- LAYOUT GRID --- */
        #app-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: 1fr 100px;
            gap: 16px;
            width: calc(100% - 32px);
            height: calc(100% - 32px);
            z-index: 10;
            position: relative;
        }

        /* --- GLASS PANEL MIXIN --- */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px); /* iOS Safari */
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: border-color 0.3s ease;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            grid-column: 1;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
            color: #fff;
        }
        .brand-icon {
            width: 32px; height: 32px;
            background: var(--dynamic-color);
            border-radius: 8px;
            box-shadow: 0 0 20px var(--dynamic-color);
            transition: background 2s ease, box-shadow 2s ease;
        }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.05);
            color: #fff;
            transform: translateX(4px);
        }
        .nav-item.active { color: var(--dynamic-color); }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }

        .library-box {
            margin-top: auto;
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: var(--radius-lg);
        }
        .lib-title { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); letter-spacing: 0.05em; margin-bottom: 12px; }
        .playlist-tag {
            display: inline-block;
            font-size: 0.8rem;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin: 0 4px 8px 0;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        .playlist-tag:hover { background: var(--dynamic-color); color: #000; font-weight: 600; }

        /* --- MAIN VIEW --- */
        .main-stage {
            grid-column: 2;
            grid-row: 1;
            padding: 40px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
        }
        .main-stage::-webkit-scrollbar { display: none; }

        /* Top Header */
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        .live-tag {
            padding: 6px 14px;
            background: rgba(255, 0, 0, 0.15);
            color: #ff4444;
            border: 1px solid rgba(255,0,0,0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }
        .live-dot { width: 6px; height: 6px; background: #ff4444; border-radius: 50%; animation: blink 2s infinite; }

        /* Hero */
        .hero-layout {
            display: flex;
            gap: 40px;
            align-items: flex-end;
            margin-bottom: 40px;
        }

        .album-art-container {
            width: 260px; height: 260px;
            flex-shrink: 0;
            border-radius: 24px;
            background: linear-gradient(135deg, #1a1a1a, #000);
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Dynamic Art Gradient */
        .album-art-container::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent, var(--dynamic-color), transparent);
            animation: rotateArt 10s linear infinite;
            opacity: 0.3;
            transition: background 2s ease;
        }
        @keyframes rotateArt { 100% { transform: rotate(360deg); } }

        .album-art-container:hover { transform: scale(1.02) rotate(-1deg); }
        
        #visualizer { position: relative; width: 100%; height: 100%; opacity: 0.8; z-index: 2; }

        .track-details h1 {
            font-size: 4rem;
            line-height: 1;
            font-weight: 800;
            letter-spacing: -0.04em;
            margin-bottom: 16px;
            background: linear-gradient(to bottom right, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: opacity 1s ease;
        }
        
        .meta-badges { display: flex; gap: 12px; margin-bottom: 24px; }
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            transition: background 2s ease;
        }
        .badge.accent { background: var(--dynamic-color); color: #000; }

        .action-row { display: flex; gap: 16px; align-items: center; }
        .play-btn-lg {
            width: 64px; height: 64px;
            border-radius: 50%;
            background: var(--dynamic-color);
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #000;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .play-btn-lg:hover { transform: scale(1.1); box-shadow: 0 0 40px var(--dynamic-color); }
        .play-btn-lg svg { width: 32px; height: 32px; fill: currentColor; margin-left: 4px; }

        /* Tracklist */
        .queue-section {
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-lg);
            padding: 8px;
        }
        .queue-row {
            display: grid;
            grid-template-columns: 40px 1fr 100px 60px;
            padding: 16px;
            align-items: center;
            border-radius: 12px;
            transition: background 0.2s;
            cursor: default;
        }
        .queue-row:hover { background: rgba(255,255,255,0.05); }
        .queue-row.active { background: rgba(255,255,255,0.08); }
        .queue-row.active .q-title { color: var(--dynamic-color); }
        
        .q-num { color: var(--text-muted); font-size: 0.9rem; }
        .q-info { display: flex; flex-direction: column; }
        .q-title { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .q-artist { font-size: 0.85rem; color: var(--text-muted); transition: opacity 1s ease;}
        .q-meta { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-align: right;}

        /* --- FLOATING PLAYER DECK --- */
        .player-deck {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
        }

        .deck-info { display: flex; align-items: center; gap: 16px; width: 30%; }
        .deck-art { 
            width: 56px; height: 56px; 
            background: #333; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .deck-art::after { 
            content: ''; 
            position: absolute; 
            inset:0; 
            background: linear-gradient(45deg, #333, var(--dynamic-color)); 
            opacity: 0.5; 
            transition: background 2s ease;
        }
        
        .deck-controls { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 40%; }
        .deck-buttons { display: flex; align-items: center; gap: 24px; }
        .deck-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
        .deck-btn:hover { color: #fff; }
        .deck-btn.main { 
            width: 40px; height: 40px; 
            background: #fff; color: #000; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .deck-btn.main:hover { transform: scale(1.1); }

        .progress-container { width: 100%; display: flex; align-items: center; gap: 12px; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; font-variant-numeric: tabular-nums; }
        .prog-track { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .prog-fill { height: 100%; width: 0%; background: var(--dynamic-color); border-radius: 10px; transition: width 1s linear, background 0.5s ease; }

        .deck-volume { width: 30%; display: flex; justify-content: flex-end; }

        /* Icon Utility */
        .icon-play, .icon-pause { display: none; }
        .show-icon { display: block; } 

        /* FADE UTILS */
        .fade-out { opacity: 0; }
        
        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 900px) {
            #app-container {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                gap: 0;
            }

            .sidebar {
                display: none; 
            }

            .main-stage {
                padding: 20px;
                padding-bottom: 120px;
                width: 100%;
            }

            .hero-layout {
                flex-direction: column;
                align-items: center;
                gap: 24px;
                text-align: center;
                margin-bottom: 30px;
            }

            .album-art-container {
                width: 200px;
                height: 200px;
            }

            .track-details h1 {
                font-size: 2.2rem;
                margin-bottom: 12px;
            }

            .meta-badges {
                justify-content: center;
                flex-wrap: wrap;
            }

            .action-row {
                display: none; /* Hide top play button on mobile */
            }

            .queue-row {
                grid-template-columns: 30px 1fr;
                gap: 10px;
                padding: 12px;
            }
            .q-meta { display: none; } 

            .player-deck {
                position: fixed;
                bottom: 16px;
                left: 16px;
                width: calc(100% - 32px);
                height: 80px;
                border-radius: 20px;
                padding: 0 20px;
                background: rgba(30, 30, 30, 0.85);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255,255,255,0.15);
                z-index: 100;
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 12px;
            }

            .deck-info { width: auto; gap: 12px; }
            .deck-art { width: 48px; height: 48px; border-radius: 8px; }
            .q-title { font-size: 0.9rem; }
            .q-artist { font-size: 0.75rem; }

            .deck-controls { 
                width: auto; 
                flex-direction: row; 
                justify-content: flex-end;
            }
            .progress-container { display: none; } 
            .deck-buttons { gap: 16px; }
            .deck-btn { display: none; } 
            .deck-btn.main { display: flex; width: 44px; height: 44px; } 
            
            .deck-volume { display: none; }

            .mobile-vibes {
                display: flex;
                gap: 8px;
                padding: 0 0 20px 0;
                overflow-x: auto;
                width: 100%;
                -webkit-overflow-scrolling: touch;
            }
            .mobile-vibes::-webkit-scrollbar { display: none; }
        }
    </style>
</head>
<body>

    <div class="ambient-glow" id="bg-glow"></div>
    <div class="noise-overlay"></div>

    <div id="app-container">
        
        <!-- SIDEBAR -->
        <nav class="sidebar glass-panel">
            <div class="brand">
                <div class="brand-icon"></div>
                <span>Lofi.fm</span>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item active">
                    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    Start Radio
                </li>
                <li class="nav-item">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
                    Focus Mode
                </li>
            </ul>

            <div class="library-box">
                <div class="lib-title">VIBE SELECTOR</div>
                <div class="playlist-tag">‚òÄÔ∏è Summer</div>
                <div class="playlist-tag">üï∫ Groovy</div>
                <div class="playlist-tag">üöÄ Uplifting</div>
                <div class="playlist-tag">zzz Sleepy</div>
            </div>
        </nav>

        <!-- MAIN STAGE -->
        <main class="main-stage glass-panel">
            <div class="stage-header">
                <div class="live-tag"><div class="live-dot"></div> LIVE BROADCAST</div>
                <div class="badge">Pro Member</div>
            </div>

            <div class="mobile-vibes" style="display: none;"></div>

            <div class="hero-layout">
                <div class="album-art-container">
                    <canvas id="visualizer"></canvas>
                </div>
                <div class="track-details">
                    <!-- Cleaned up mobile list -->
                    <div class="mobile-vibes-list" style="display:none; overflow-x:auto; gap:8px; margin-bottom:16px; width:100%; white-space:nowrap;">
                         <!-- Intentionally empty per request -->
                    </div>

                    <div class="meta-badges">
                        <span class="badge accent" id="style-badge">Classic</span>
                        <span class="badge" id="mood-badge">Neutral</span>
                        <span class="badge" id="bpm-badge">80 BPM</span>
                    </div>
                    <h1 id="playlist-title">Loading Stream...</h1>
                    <div class="action-row">
                        <button class="play-btn-lg" id="playBtn">
                            <svg class="icon-play show-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                        <span style="font-weight: 600; color: var(--text-muted); font-size: 0.9rem;">Syncing with Global Server...</span>
                    </div>
                </div>
            </div>

            <div class="queue-section" id="queue-container">
            </div>
        </main>

        <!-- PLAYER DECK -->
        <footer class="player-deck glass-panel">
            <div class="deck-info">
                <div class="deck-art">
                    <!-- Icon Placeholder -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="rgba(255,255,255,0.5)"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>
                </div>
                <div>
                    <div class="q-title" id="bar-title">Connecting...</div>
                    <div class="q-artist" id="bar-artist">Generative.fm</div>
                </div>
            </div>

            <div class="deck-controls">
                <div class="deck-buttons">
                    <button class="deck-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button class="deck-btn main" id="barPlayBtn">
                        <svg class="icon-play show-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        <svg class="icon-pause" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <!-- Next button hidden on mobile via CSS deck-btn class logic -->
                    <button class="deck-btn" id="nextBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                </div>
                <div class="progress-container">
                    <span id="time-current">0:00</span>
                    <div class="prog-track"><div class="prog-fill" id="progress-bar"></div></div>
                    <span id="time-total">--:--</span>
                </div>
            </div>

            <div class="deck-volume">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#666"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </div>
        </footer>

    </div>

<script>
    /**
     * LOFI.FM AUDIO ENGINE v8.0 (Hit Song + Motif + Loop Engine)
     */

    function mulberry32(a) {
        return function() {
          var t = a += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }

    const MIN_TRACK_MS = 95 * 1000; 
    const MAX_TRACK_MS = 180 * 1000;
    
    let currentRNG = null; 
    let isTransitioning = false;
    let isInitializing = false; 

    // --- METADATA (expanded for more variety so tracks feel less samey) ---
    const TITLES_A = ["Midnight", "Sun", "Urban", "Funky", "Cosmic", "Rainy", "Sunday", "Coffee", "Neon", "Happy", "Silent", "Golden", "Floating", "Hollow", "Velvet", "Soft", "Late", "Early", "Pink", "Blue", "Warm", "Cold", "Lost", "Safe"];
    const TITLES_B = ["Dreams", "Day", "Loop", "Groove", "Thoughts", "Vibes", "Window", "Clouds", "Station", "Memories", "Soul", "Static", "Waves", "Pages", "Lights", "Hours", "Nights", "Side", "Noise", "Tape", "Room", "Sky", "Mood", "Beat"];
    const ARTISTS_A = ["Lo-Fi", "Chill", "Beats", "Bedroom", "Analog", "Digital", "Sleepy", "Mellow", "Jazz", "Retro", "Lazy", "Quiet", "Soft", "Deep", "Warm"];
    const ARTISTS_B = ["Boy", "Girl", "Project", "Collective", "Hop", "Cat", "Smith", "Waves", "FM", "Tapes", "Corner", "Society", "Lab", "Room", "Band"];

    // --- CONFIG ---
    const NOTES = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];
    const MOOD_SCALES = { 'Melancholic': ['Minor', 'Phrygian'], 'Chill': ['Dorian', 'Minor'], 'Uplifting': ['Major', 'Lydian'], 'Groovy': ['Mixolydian', 'Dorian'] };
    const MODES = { 'Minor': [0, 2, 3, 5, 7, 8, 10], 'Dorian': [0, 2, 3, 5, 7, 9, 10], 'Major': [0, 2, 4, 5, 7, 9, 11], 'Lydian': [0, 2, 4, 6, 7, 9, 11], 'Phrygian': [0, 1, 3, 5, 7, 8, 10], 'Mixolydian': [0, 2, 4, 5, 7, 9, 10] };

    // --- DRUM LOOP LIBRARY (Hit Patterns) ---
    // 1 = Kick, 2 = Snare, 0 = Empty. 16-step grid.
    const DRUM_LOOPS = {
        'Basic': [1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0],
        'BoomBap': [1,0,0,1, 2,0,0,0, 0,1,0,0, 2,0,0,0],
        'Dilla': [1,0,0,0, 2,0,0,1, 0,0,1,0, 2,0,0,0],
        'Chill': [1,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0],
        'House': [1,0,1,0, 2,0,1,0, 1,0,1,0, 2,0,1,0],
        'Trap': [1,0,0,1, 2,0,2,0, 1,0,0,1, 2,0,0,0],
        'Sparse': [1,0,0,0, 0,2,0,0, 1,0,0,0, 0,0,2,0],
        'Syncopated': [1,0,0,1, 0,2,0,0, 1,0,1,0, 2,0,0,1]
    };

    const STYLES = {
        'Chill Hop': { bpmRange: [80, 92], swing: 0.06, drumDensity: 0.7, bitCrush: 0, hasLead: true, isGuitar: false, color: '#ef4444' },
        'Classic': { bpmRange: [70, 80], swing: 0.04, drumDensity: 0.4, bitCrush: 4, hasLead: true, isGuitar: false, color: '#f59e0b' },
        'Sleepy': { bpmRange: [50, 65], swing: 0.02, drumDensity: 0.1, bitCrush: 8, hasLead: false, isGuitar: false, color: '#3b82f6' },
        'Summer': { bpmRange: [85, 100], swing: 0.03, drumDensity: 0.6, bitCrush: 2, hasLead: true, isGuitar: true, color: '#eab308' },
        'Funk': { bpmRange: [90, 105], swing: 0.15, drumDensity: 0.8, bitCrush: 0, hasLead: true, isGuitar: false, color: '#d946ef' },
        'Jazzy': { bpmRange: [72, 88], swing: 0.12, drumDensity: 0.5, bitCrush: 2, hasLead: true, isGuitar: false, color: '#8b5cf6' },
        'Minimal': { bpmRange: [60, 72], swing: 0.02, drumDensity: 0.2, bitCrush: 6, hasLead: false, isGuitar: false, color: '#64748b' },
        'Bounce': { bpmRange: [88, 98], swing: 0.08, drumDensity: 0.65, bitCrush: 0, hasLead: true, isGuitar: false, color: '#ec4899' }
    };

    const state = {
        isPlaying: false,
        timeOffset: 0, 
        currentSeed: 0,
        trackStartTime: 0,
        trackDuration: 0,
        
        style: 'Classic',
        mood: 'Chill',
        key: 'C',
        mode: 'Minor',
        scale: [],
        progression: [],
        bpm: 75,
        barCount: 0,
        section: 'Verse',
        
        // HIT SONG VARIABLES
        trackMotif: [], // The catchy melody
        drumPattern: [], // The chosen drum loop
        bassPattern: [], // The bass groove
        
        activeLeadNote: null,
        params: { swing: 0.04, drumDensity: 0.5 }
    };

    // Nodes
    let radioGroup, stopClick; 
    let keys, pad, bass, lead, kick, snare, hihat, foley;
    let masterFilter, chorus, delay, reverb, bitCrusher, compressor, limiter;
    let vinylNoise, rainNoise, windNoise, filterLFO, padVolumeLFO, analyser;
    let autoPanner, tremolo, vibrato;
    let pageVisible = true;

    /** Resume AudioContext when page is visible again (fixes fragmented sound in car/background) */
    function setupVisibilityHandling() {
        pageVisible = document.visibilityState === 'visible';
        document.addEventListener('visibilitychange', () => {
            pageVisible = document.visibilityState === 'visible';
            const ctx = Tone.context.rawContext || (Tone.getContext && Tone.getContext().rawContext);
            if (ctx && ctx.state === 'suspended' && state.isPlaying) {
                ctx.resume().then(() => {
                    if (state.isPlaying) {
                        Tone.Transport.start();
                        if (vinylNoise) vinylNoise.start();
                        if (padVolumeLFO) padVolumeLFO.start();
                    }
                }).catch(() => {});
            }
        });
        // Resume on user gesture (e.g. tap after returning to app)
        const resumeOnInteraction = () => {
            const ctx = Tone.context.rawContext || (Tone.getContext && Tone.getContext().rawContext);
            if (ctx && ctx.state === 'suspended') {
                ctx.resume().then(() => {}).catch(() => {});
            }
            document.removeEventListener('click', resumeOnInteraction);
            document.removeEventListener('touchstart', resumeOnInteraction);
        };
        document.addEventListener('click', resumeOnInteraction, { once: true });
        document.addEventListener('touchstart', resumeOnInteraction, { once: true });
    }

    // --- INIT ---
    async function initAudio() {
        if(isInitializing) return;
        isInitializing = true;

        await Tone.start();
        Tone.context.latencyHint = 'playback';
        // Reduce fragmentation when tab is in background (e.g. car): use a slightly larger buffer
        if (Tone.context.rawContext && Tone.context.rawContext.baseLatency) {
            try { Tone.context.rawContext.latencyHint = 'playback'; } catch (e) {}
        }
        
        radioGroup = new Tone.Gain(1).toDestination();
        
        stopClick = new Tone.MembraneSynth({
            pitchDecay: 0.008,
            octaves: 4,
            oscillator: { type: "square4" },
            envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
        }).toDestination();
        stopClick.volume.value = -5;

        limiter = new Tone.Limiter(-1).connect(radioGroup); 
        compressor = new Tone.Compressor(-12, 3).connect(limiter);
        masterFilter = new Tone.Filter(1000, "lowpass").connect(compressor);
        filterLFO = new Tone.LFO(0.05, 400, 1200).start();
        filterLFO.connect(masterFilter.frequency);
        
        reverb = new Tone.JCReverb(0.3).connect(masterFilter);
        delay = new Tone.PingPongDelay("8n", 0.1).connect(reverb);
        chorus = new Tone.Chorus(2, 2.5, 0.5).connect(delay).start(); 
        bitCrusher = new Tone.BitCrusher(8).connect(chorus);

        autoPanner = new Tone.AutoPanner("2n").start().connect(delay); 
        tremolo = new Tone.Tremolo(5, 0.5).start().connect(bitCrusher); 
        vibrato = new Tone.Vibrato(5, 0.1).connect(autoPanner); 

        keys = new Tone.PolySynth(Tone.Synth, { volume: -15, oscillator: { type: "fatsine" }, envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1 } }).connect(tremolo);
        pad = new Tone.PolySynth(Tone.Synth, { volume: -20, oscillator: { type: "sine" }, envelope: { attack: 1.5, decay: 1, sustain: 0.8, release: 3 } }).connect(reverb);
        padVolumeLFO = new Tone.LFO(0.1, -25, -15).start();
        padVolumeLFO.connect(pad.volume);

        bass = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.9, release: 1 }, volume: -2 }).connect(compressor); 
        lead = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.2, release: 1 }, volume: -18 }).connect(vibrato); 

        kick = new Tone.MembraneSynth({ volume: 0 }).connect(compressor);
        snare = new Tone.NoiseSynth({ volume: -2, envelope: { decay: 0.2 } }).connect(masterFilter); 
        hihat = new Tone.MetalSynth({ volume: -18, frequency: 200, envelope: { decay: 0.05 } }).connect(reverb);
        
        // Foley Layer (Bird chirps, tape clicks etc.)
        foley = new Tone.Player("https://tonejs.github.io/audio/berklee/gong_1.mp3").connect(reverb); // Placeholder URL, in real app use generated noise bursts
        // Using a noise synth for foley instead to be self-contained
        foley = new Tone.NoiseSynth({ volume: -20, envelope: { attack: 0.01, decay: 0.1 } }).connect(reverb);

        const noiseGain = new Tone.Gain(1).connect(radioGroup);
        vinylNoise = new Tone.Noise("brown").start(); 
        vinylNoise.connect(new Tone.Filter(500, "highpass").connect(noiseGain));
        vinylNoise.volume.value = -45; 
        
        rainNoise = new Tone.Noise("pink").start(); 
        rainNoise.connect(new Tone.AutoFilter("0.1hz").connect(noiseGain));
        rainNoise.volume.value = -99; 

        windNoise = new Tone.Noise("white").start(); 
        const windFilter = new Tone.Filter(800, "bandpass").connect(noiseGain);
        windNoise.connect(windFilter);
        windNoise.volume.value = -99;

        analyser = new Tone.Analyser("fft", 64);
        masterFilter.connect(analyser);

        if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) {} }
        
        // Keep AudioContext running when tab is in background (prevents car/phone fragmentation)
        setupVisibilityHandling();

        state.isPlaying = true;
        isInitializing = false;
        
        const trackInfo = getCurrentTrackInfo();
        state.currentSeed = trackInfo.seed;
        state.trackStartTime = trackInfo.startTime;
        state.trackDuration = trackInfo.duration;
        
        generateNewTrack(state.currentSeed);
        updateQueueUI();
        
        startSequencer();
        drawVisualizer();
        
        setInterval(updateAudioLogic, 1000); 
        setInterval(updateUIProgress, 200); 
        updatePlayButtonUI(true);
    }

    // Mix time-based pointer into a more varied seed so consecutive tracks don't sound alike
    function diversifySeed(pointer) {
        const p = Math.floor(pointer);
        return ((p * 2654435761) >>> 0) + (p % 86400000);
    }

    // --- ENGINE ---
    function getCurrentTrackInfo() {
        const now = Date.now() + state.timeOffset;
        const currentHour = Math.floor(now / 3600000); 
        
        let pointer = currentHour * 3600000;
        let trackSeed = 0;
        let duration = 0;

        while (pointer < now + MAX_TRACK_MS) {
            const seedForDuration = diversifySeed(pointer);
            const trackRng = mulberry32(seedForDuration);
            duration = MIN_TRACK_MS + Math.floor(trackRng() * (MAX_TRACK_MS - MIN_TRACK_MS));
            
            if (pointer + duration > now) {
                trackSeed = seedForDuration;
                return { seed: trackSeed, startTime: pointer, duration: duration };
            }
            pointer += duration;
        }
    }

    function updateAudioLogic() {
        if (!state.isPlaying) return;
        
        const now = Date.now() + state.timeOffset;
        const timeRemaining = (state.trackStartTime + state.trackDuration) - now;

        if (timeRemaining < 5000 && !isTransitioning) {
            isTransitioning = true;
            radioGroup.gain.rampTo(0, 4); 
            if(filterLFO) { filterLFO.max = 200; filterLFO.frequency.rampTo(0.1, 4); }
            fadeUIText(false);
        }

        if (timeRemaining <= 0) {
            const nextTrack = getCurrentTrackInfo();
            state.currentSeed = nextTrack.seed;
            state.trackStartTime = nextTrack.startTime;
            state.trackDuration = nextTrack.duration;
            
            generateNewTrack(state.currentSeed);
            updateQueueUI();
            
            radioGroup.gain.rampTo(1, 4);
            fadeUIText(true);
            isTransitioning = false;
        }
    }

    function fadeUIText(fadeIn) {
        const opacity = fadeIn ? '1' : '0';
        document.getElementById('playlist-title').style.opacity = opacity;
        document.getElementById('bar-artist').style.opacity = opacity;
        document.getElementById('bar-title').style.opacity = opacity;
    }

    function generateNewTrack(seed) {
        currentRNG = mulberry32(seed);

        const moods = ['Melancholic', 'Chill', 'Uplifting', 'Groovy', 'Uplifting']; 
        state.mood = moods[Math.floor(currentRNG() * moods.length)];

        const styleKeys = Object.keys(STYLES);
        state.style = styleKeys[Math.floor(currentRNG() * styleKeys.length)];
        const config = STYLES[state.style];

        state.key = NOTES[Math.floor(currentRNG() * NOTES.length)];
        const availableModes = MOOD_SCALES[state.mood];
        state.mode = availableModes[Math.floor(currentRNG() * availableModes.length)];
        state.scale = generateScale(state.key, state.mode);
        state.progression = generateProgression(state.mode);
        
        let bpm = config.bpmRange[0] + Math.floor(currentRNG() * (config.bpmRange[1] - config.bpmRange[0]));
        if (state.mood === 'Melancholic') bpm -= 5;
        if (state.mood === 'Uplifting' || state.mood === 'Groovy') bpm += 5;
        state.bpm = Math.max(50, Math.min(110, bpm));
        
        Tone.Transport.bpm.value = state.bpm; 

        state.params.swing = config.swing;
        state.params.drumDensity = config.drumDensity;
        
        // HIT SONG LOGIC: Generate specific loops for this track
        // 1. Drum Loop
        const drumKeys = Object.keys(DRUM_LOOPS);
        const drumKey = drumKeys[Math.floor(currentRNG() * drumKeys.length)];
        state.drumPattern = DRUM_LOOPS[drumKey];
        
        // 2. Motif (Melody Hook) - 8 notes for more variety per track
        state.trackMotif = [];
        const motifLen = 8;
        for (let i = 0; i < motifLen; i++) {
            const idx = Math.floor(currentRNG() * 7);
            const octave = 4 + (currentRNG() > 0.85 ? 1 : 0);
            state.trackMotif.push(state.scale[idx] + octave);
        }

        // 3. Bass Groove - more variation by style
        const bassRng = currentRNG();
        state.bassPattern = [
            1, bassRng > 0.5 ? 0 : 1, 0, 0, 0, 0, 0, 0,
            currentRNG() > 0.4 ? 1 : 0, 0, 0, 0, 0, 0, 0, 0
        ];

        bitCrusher.wet.value = (state.style === 'Chill Hop' || state.style === 'Summer') ? 0 : 0.5; 
        bitCrusher.bits.value = config.bitCrush || 8; 
        tremolo.wet.value = (state.mood === 'Melancholic') ? 0.6 : 0; 
        
        if(filterLFO) {
            if(state.mood === 'Uplifting' || state.mood === 'Groovy') {
                filterLFO.min = 800; filterLFO.max = 2500; 
            } else if (state.mood === 'Melancholic') {
                filterLFO.min = 200; filterLFO.max = 600; 
            } else {
                filterLFO.min = 400; filterLFO.max = 1200; 
            }
        }

        applyKeysPatch(config);

        const vinylLvl = -40 - currentRNG() * 5; 
        vinylNoise.volume.rampTo(vinylLvl, 2);
        
        let rainLvl = -99;
        let windLvl = -99;

        if (state.mood === 'Melancholic') rainLvl = -25;
        else if (state.mood === 'Uplifting') windLvl = -35; 
        if (state.style === 'Sleepy') rainLvl = -20; 

        rainNoise.volume.rampTo(rainLvl, 1);
        windNoise.volume.rampTo(windLvl, 1);

        const meta = generateMetadata(seed);
        
        setTimeout(() => {
            document.getElementById('playlist-title').innerText = meta.title;
            document.getElementById('bar-title').innerText = meta.title;
            document.getElementById('bar-artist').innerText = meta.artist;
            document.getElementById('style-badge').innerText = state.style;
            document.getElementById('mood-badge').innerText = state.mood; 
            document.getElementById('bpm-badge').innerText = `${state.bpm} BPM`;
            
            let color = config.color;
            if(state.mood === 'Melancholic') color = '#6366f1'; 
            if(state.mood === 'Uplifting') color = '#10b981'; 
            if(state.mood === 'Groovy') color = '#d946ef';
            document.documentElement.style.setProperty('--dynamic-color', color);
        }, 1000); 

        state.barCount = 0;
        state.section = 'Verse';
    }

    function generateMetadata(seed) {
        let rng = mulberry32(seed);
        const titleA = TITLES_A[Math.floor(rng() * TITLES_A.length)];
        const titleB = TITLES_B[Math.floor(rng() * TITLES_B.length)];
        const artistA = ARTISTS_A[Math.floor(rng() * ARTISTS_A.length)];
        const artistB = ARTISTS_B[Math.floor(rng() * ARTISTS_B.length)];
        return { title: `${titleA} ${titleB}`, artist: `${artistA} ${artistB}` };
    }

    function updateQueueUI() {
        const queueContainer = document.getElementById('queue-container');
        queueContainer.innerHTML = ''; 
        
        let pointer = state.trackStartTime; 
        let trackRng, dur, seed;

        seed = diversifySeed(pointer);
        trackRng = mulberry32(seed);
        let currentDur = MIN_TRACK_MS + Math.floor(trackRng() * (MAX_TRACK_MS - MIN_TRACK_MS));
        pointer += currentDur;

        for (let i = 1; i <= 3; i++) {
            seed = diversifySeed(pointer);
            trackRng = mulberry32(seed);
            dur = MIN_TRACK_MS + Math.floor(trackRng() * (MAX_TRACK_MS - MIN_TRACK_MS));
            
            const nextMeta = generateMetadata(seed);
            const nextStyle = getStyleForSeed(seed);
            addTrackRow(queueContainer, i, nextMeta, nextStyle, false);
            pointer += dur;
        }
    }

    function getStyleForSeed(seed) {
        const styleKeys = Object.keys(STYLES);
        return styleKeys[Math.floor(mulberry32(seed)() * styleKeys.length)];
    }

    function addTrackRow(container, num, meta, styleName, isActive) {
        const div = document.createElement('div');
        div.className = `queue-row ${isActive ? 'active' : ''}`;
        div.innerHTML = `
            <div class="q-num">${isActive ? '‚ñ∂' : num}</div>
            <div class="q-info">
                <div class="q-title">${meta.title}</div>
                <div class="q-artist">${meta.artist}</div>
            </div>
            <div class="q-meta">${styleName}</div>
            <div class="q-meta"></div>
        `;
        container.appendChild(div);
    }

    function generateScale(root, modeName) {
        const rootIdx = NOTES.indexOf(root);
        const intervals = MODES[modeName];
        return intervals.map(i => NOTES[(rootIdx + i) % 12]);
    }
    
    function getChord(degree, scale, octave = 3) {
        const r = (degree - 1) % 7;
        const t = (degree + 1) % 7;
        const f = (degree + 3) % 7;
        const s = (degree + 5) % 7;
        const chord = [scale[r]+octave, scale[t]+octave, scale[f]+octave, scale[s]+octave];
        if (Math.random() > 0.5) {
            const n = degree % 7; 
            chord.push(scale[n] + (octave + 1));
        }
        return chord;
    }
    
    function generateProgression(mode) {
        let templates;
        if (mode === 'Major' || mode === 'Lydian') {
            templates = [[1, 5, 6, 4], [1, 4, 5, 1], [2, 5, 1, 1], [1, 4, 1, 5], [1, 6, 4, 5], [4, 1, 5, 6], [1, 3, 4, 5]];
        } else if (mode === 'Mixolydian') {
            templates = [[1, 7, 4, 1], [1, 4, 1, 7], [1, 4, 7, 1], [4, 1, 7, 4]];
        } else {
            templates = [[2, 5, 1, 6], [1, 6, 2, 5], [6, 4, 1, 5], [4, 5, 3, 6], [1, 5, 6, 3], [1, 4, 6, 5], [6, 2, 5, 1], [3, 6, 4, 1]];
        }
        return templates[Math.floor(currentRNG() * templates.length)];
    }
    
    function applyKeysPatch(config) {
        if (config.isGuitar) {
            keys.set({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.4, sustain: 0.2, release: 0.8 }, volume: -12, detune: Math.random() * 4 - 2 });
            chorus.wet.value = 0.5; 
        } else {
            const wave = (state.style === 'Chill Hop' || state.style === 'Funk') ? 'square' : 'fatsine';
            keys.set({ oscillator: { type: wave }, envelope: { attack: state.style === 'Sleepy' ? 0.2 : 0.05, decay: 0.2, sustain: 0.3, release: 0.8 }, volume: -15, detune: 0 });
            chorus.wet.value = 0.3; 
        }
    }

    function startSequencer() {
        Tone.Transport.cancel();
        Tone.Transport.start("+0.1");
        let step = 0;
        Tone.Transport.scheduleRepeat((time) => {
            const sixteenth = step % 4; 
            const t = time + state.params.swing * (sixteenth % 2 === 1 ? 1 : 0);
            const config = STYLES[state.style];

            // HARMONY (Keys/Chords)
            if (step % 16 === 0) {
                const progIdx = Math.floor(state.barCount % 4); 
                const degree = state.progression[progIdx];
                const notes = getChord(degree, state.scale, 3);
                
                if (state.style === 'Guitar' || state.style === 'Summer') notes.forEach((n, i) => keys.triggerAttackRelease(n, "2n", t + (i * 0.05), 0.5));
                else keys.triggerAttackRelease(notes, "1m", t, 0.4); 
                
                if (Math.random() > 0.4) pad.triggerAttackRelease(notes, "1m", t, 0.4);
                
                // Bass pattern: Root on 1, maybe fifth on 3
                const bassOctave = degree === 1 ? 1 : 2;
                const rootNote = notes[0].replace(/\d/, bassOctave);
                // Simple pattern for now
                bass.triggerAttackRelease(rootNote, "2n", t, 0.7);
            }

            // HIT SONG: Play the generated Motif (8 notes, cycle every 2 bars)
            if (config.hasLead && state.section === 'Verse') {
                if (step % 4 === 0) {
                    const motifIdx = (Math.floor(step / 4) + state.barCount * 2) % (state.trackMotif.length || 8);
                    if (state.trackMotif && state.trackMotif[motifIdx] && Math.random() > 0.25) {
                        lead.triggerAttackRelease(state.trackMotif[motifIdx], "8n", t);
                    }
                }
            }

            // DRUMS (Pattern Based)
            if (state.section !== 'Breakdown') {
                const patIdx = step % 16;
                // Kick
                if (state.drumPattern && state.drumPattern[patIdx] === 1) {
                    kick.triggerAttackRelease("C1", "8n", t);
                }
                // Snare
                if (state.drumPattern && state.drumPattern[patIdx] === 2) {
                    snare.triggerAttackRelease("16n", t);
                }
                
                // HiHats (Simple filler)
                if (step % 2 === 0) hihat.triggerAttackRelease("32n", t, 0.2 + Math.random()*0.1);
            }
            
            // Foley (Occasional)
            if (Math.random() < 0.01) foley.triggerAttackRelease("32n", t, 0.2);

            step = (step + 1) % 16;
            if (step === 0) {
                state.barCount++;
                state.section = (state.barCount >= 16 && state.barCount < 24) ? 'Breakdown' : 'Verse';
            }
        }, "16n");
    }

    function updateUIProgress() {
        if (!state.isPlaying) return;
        const now = Date.now() + state.timeOffset;
        const elapsed = now - state.trackStartTime;
        const duration = state.trackDuration;
        let percent = (elapsed / duration) * 100;
        percent = Math.max(0, Math.min(100, percent)); 
        document.getElementById('progress-bar').style.width = percent + '%';
        const s = Math.floor(elapsed / 1000);
        const totalS = Math.floor(duration / 1000);
        const m = Math.floor(s/60);
        const sec = (s%60).toString().padStart(2,'0');
        document.getElementById('time-current').innerText = `${m}:${sec}`;
        const totalM = Math.floor(totalS/60);
        const totalSec = (totalS%60).toString().padStart(2,'0');
        document.getElementById('time-total').innerText = `${totalM}:${totalSec}`;
    }

    function updatePlayButtonUI(playing) {
        const heroPlay = document.querySelector('#playBtn .icon-play');
        const heroPause = document.querySelector('#playBtn .icon-pause');
        if(heroPlay && heroPause) {
            heroPlay.style.display = playing ? 'none' : 'block';
            heroPause.style.display = playing ? 'block' : 'none';
        }
        const barPlay = document.querySelector('#barPlayBtn .icon-play');
        const barPause = document.querySelector('#barPlayBtn .icon-pause');
        if(barPlay && barPause) {
            barPlay.style.display = playing ? 'none' : 'block';
            barPause.style.display = playing ? 'block' : 'none';
        }
    }

    async function togglePlay() {
        if(isInitializing) return;
        
        if(!radioGroup) {
            await initAudio();
            return;
        }

        if(state.isPlaying) {
            state.isPlaying = false;
            updatePlayButtonUI(false);
            stopClick.triggerAttackRelease("C2", "8n");
            radioGroup.gain.rampTo(0, 0.2); 
            setTimeout(() => {
                Tone.Transport.pause();
                vinylNoise.stop(); rainNoise.stop(); windNoise.stop();
                if(padVolumeLFO) padVolumeLFO.stop();
                keys.releaseAll(); pad.releaseAll(); 
            }, 250);
        } else {
            if(Tone.context.state !== 'running') await Tone.start();
            radioGroup.gain.value = 1; 
            state.isPlaying = true;
            Tone.Transport.start();
            vinylNoise.start(); 
            if(padVolumeLFO) padVolumeLFO.start();
            if (state.mood === 'Melancholic' || state.style === 'Sleepy') rainNoise.start();
            if (state.mood === 'Uplifting') windNoise.start();
            updatePlayButtonUI(true);
            drawVisualizer();
        }
    }

    function drawVisualizer() {
        if (!state.isPlaying) return;
        requestAnimationFrame(drawVisualizer);
        // Pause visualizer when tab hidden to save CPU and reduce audio fragmentation (e.g. in car)
        if (!pageVisible || document.visibilityState === 'hidden') return;
        const bufferLength = analyser.getValue().length;
        const dataArray = analyser.getValue(); 
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        const barWidth = (w / bufferLength) * 2;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
            const val = dataArray[i] + 140; 
            const barHeight = Math.max(0, val * 2.5); 
            ctx.fillStyle = `rgba(255, 255, 255, 0.3)`;
            ctx.beginPath();
            ctx.roundRect(x, h/2 - barHeight/2, barWidth, barHeight, 50);
            ctx.fill();
            x += barWidth + 2;
        }
    }

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    
    if(window.innerWidth <= 900) {
        document.querySelector('.mobile-vibes-list').style.display = 'flex';
    }

    document.getElementById('playBtn').addEventListener('click', () => { if(Tone.Transport.state === 'started' || radioGroup) togglePlay(); else initAudio(); });
    document.getElementById('barPlayBtn').addEventListener('click', () => { if(Tone.Transport.state === 'started' || radioGroup) togglePlay(); else initAudio(); });
    
    document.getElementById('nextBtn').addEventListener('click', () => { 
        if(!radioGroup) return; 
        const now = Date.now() + state.timeOffset;
        const timeRemaining = (state.trackStartTime + state.trackDuration) - now;
        state.timeOffset += (timeRemaining + 100); 
        updateAudioLogic();
    });

</script>
</body>
</html>