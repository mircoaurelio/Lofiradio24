<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Lofi 24h - Premium Radio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --bg-deep: #050505;
            --glass-panel: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --dynamic-color: #e0aa3e; /* Updates via JS */
            --radius-xl: 24px;
            --radius-lg: 16px;
            --sidebar-width: 260px;
            --app-height: 100dvh; /* iOS Fix */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: var(--app-height);
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- DYNAMIC BACKGROUND --- */
        .ambient-glow {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 50% 50%, var(--dynamic-color), transparent 70%);
            opacity: 0.15;
            z-index: 0;
            transition: background 3s ease; /* Slower transition */
            pointer-events: none;
        }
        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwMDAwIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wOCkiLz4KPC9zdmc+');
            opacity: 0.6;
            z-index: 1;
            pointer-events: none;
        }

        /* --- LAYOUT GRID --- */
        #app-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: 1fr 100px;
            gap: 16px;
            width: calc(100% - 32px);
            height: calc(100% - 32px);
            z-index: 10;
            position: relative;
        }

        /* --- GLASS PANEL MIXIN --- */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px); /* iOS Safari */
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: border-color 0.3s ease;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            grid-column: 1;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
            color: #fff;
        }
        .brand-icon {
            width: 32px; height: 32px;
            background: var(--dynamic-color);
            border-radius: 8px;
            box-shadow: 0 0 20px var(--dynamic-color);
            transition: background 2s ease, box-shadow 2s ease;
        }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.05);
            color: #fff;
            transform: translateX(4px);
        }
        .nav-item.active { color: var(--dynamic-color); }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }
        .nav-item .nav-link { display: flex; align-items: center; gap: 12px; color: inherit; text-decoration: none; }
        .nav-item .nav-link:hover { color: inherit; }

        .library-box {
            margin-top: auto;
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: var(--radius-lg);
        }
        .lib-title { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); letter-spacing: 0.05em; margin-bottom: 12px; }
        .playlist-tag {
            display: inline-block;
            font-size: 0.8rem;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin: 0 4px 8px 0;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        .playlist-tag:hover { background: var(--dynamic-color); color: #000; font-weight: 600; }

        /* --- MAIN VIEW --- */
        .main-stage {
            grid-column: 2;
            grid-row: 1;
            padding: 40px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
        }
        .main-stage::-webkit-scrollbar { display: none; }

        /* Top Header */
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        .live-tag {
            padding: 6px 14px;
            background: rgba(255, 0, 0, 0.15);
            color: #ff4444;
            border: 1px solid rgba(255,0,0,0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }
        .live-dot { width: 6px; height: 6px; background: #ff4444; border-radius: 50%; animation: blink 2s infinite; }

        /* Hero */
        .hero-layout {
            display: flex;
            gap: 40px;
            align-items: flex-end;
            margin-bottom: 40px;
        }

        .album-art-container {
            width: 260px; height: 260px;
            flex-shrink: 0;
            border-radius: 24px;
            background: linear-gradient(135deg, #1a1a1a, #000);
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Dynamic Art Gradient */
        .album-art-container::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent, var(--dynamic-color), transparent);
            animation: rotateArt 10s linear infinite;
            opacity: 0.3;
            transition: background 2s ease;
        }
        @keyframes rotateArt { 100% { transform: rotate(360deg); } }

        .album-art-container:hover { transform: scale(1.02) rotate(-1deg); }
        
        #visualizer { position: relative; width: 100%; height: 100%; opacity: 0.8; z-index: 2; }

        .track-details h1 {
            font-size: 4rem;
            line-height: 1;
            font-weight: 800;
            letter-spacing: -0.04em;
            margin-bottom: 16px;
            padding-bottom: 1rem;
            background: linear-gradient(to bottom right, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: opacity 1s ease;
        }
        
        .meta-badges { display: flex; gap: 12px; margin-bottom: 24px; }
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            transition: background 2s ease;
        }
        .badge.accent { background: var(--dynamic-color); color: #000; }

        .action-row { display: flex; gap: 16px; align-items: center; }
        .play-btn-lg {
            width: 64px; height: 64px;
            border-radius: 50%;
            background: var(--dynamic-color);
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #000;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .play-btn-lg:hover { transform: scale(1.1); box-shadow: 0 0 40px var(--dynamic-color); }
        .play-btn-lg svg { width: 32px; height: 32px; fill: currentColor; margin-left: 4px; }

        /* Tracklist */
        .queue-section {
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-lg);
            padding: 8px;
        }
        .queue-row {
            display: grid;
            grid-template-columns: 40px 1fr 100px 60px;
            padding: 16px;
            align-items: center;
            border-radius: 12px;
            transition: background 0.2s;
            cursor: default;
        }
        .queue-row:hover { background: rgba(255,255,255,0.05); }
        .queue-row.active { background: rgba(255,255,255,0.08); }
        .queue-row.active .q-title { color: var(--dynamic-color); }
        
        .queue-header { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); letter-spacing: 0.05em; margin-bottom: 12px; padding: 8px 16px 0; }
        .q-num { color: var(--text-muted); font-size: 0.9rem; }
        .q-info { display: flex; flex-direction: column; }
        .q-title { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .q-artist { font-size: 0.85rem; color: var(--text-muted); transition: opacity 1s ease;}
        .q-meta { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-align: right;}

        /* --- FLOATING PLAYER DECK --- */
        .player-deck {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
        }

        .deck-info { display: flex; align-items: center; gap: 16px; width: 30%; }
        .deck-art { 
            width: 56px; height: 56px; 
            background: #333; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .deck-art::after { 
            content: ''; 
            position: absolute; 
            inset:0; 
            background: linear-gradient(45deg, #333, var(--dynamic-color)); 
            opacity: 0.5; 
            transition: background 2s ease;
        }
        
        .deck-controls { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 40%; }
        .deck-buttons { display: flex; align-items: center; gap: 24px; }
        .deck-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
        .deck-btn:hover { color: #fff; }
        .deck-btn.main { 
            width: 40px; height: 40px; 
            background: #fff; color: #000; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .deck-btn.main:hover { transform: scale(1.1); }

        .progress-container { width: 100%; display: flex; align-items: center; gap: 12px; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; font-variant-numeric: tabular-nums; }
        .prog-track { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .prog-fill { height: 100%; width: 0%; background: var(--dynamic-color); border-radius: 10px; transition: width 1s linear, background 0.5s ease; }

        .deck-volume { width: 30%; display: flex; justify-content: flex-end; }

        /* Icon Utility */
        .icon-play, .icon-pause { display: none; }
        .show-icon { display: block; } 

        /* FADE UTILS */
        .fade-out { opacity: 0; }
        
        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 900px) {
            #app-container {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                gap: 0;
            }

            .sidebar {
                display: none; 
            }

            .main-stage {
                padding: 20px;
                padding-bottom: 120px;
                width: 100%;
            }

            .hero-layout {
                flex-direction: column;
                align-items: center;
                gap: 24px;
                text-align: center;
                margin-bottom: 30px;
            }

            .album-art-wrapper { display: flex; flex-direction: column; align-items: center; gap: 12px; }
            .album-art-container {
                width: 280px;
                height: 280px;
            }
            .mobile-track-time {
                display: flex;
                align-items: center;
                gap: 10px;
                width: 100%;
                max-width: 280px;
                font-size: 0.8rem;
                color: var(--text-muted);
                font-weight: 600;
                font-variant-numeric: tabular-nums;
            }
            .mobile-track-time .mobile-prog { flex: 1; height: 4px; }

            .track-details h1 {
                font-size: 2.2rem;
                margin-bottom: 12px;
                padding-bottom: 0.75rem;
            }

            .meta-badges {
                justify-content: center;
                flex-wrap: wrap;
            }

            .action-row {
                display: none; /* Hide top play button on mobile */
            }

            .queue-row {
                grid-template-columns: 30px 1fr;
                gap: 10px;
                padding: 12px;
            }
            .q-meta { display: none; } 

            .player-deck {
                position: fixed;
                bottom: 16px;
                left: 16px;
                width: calc(100% - 32px);
                height: 80px;
                border-radius: 20px;
                padding: 0 20px;
                background: rgba(30, 30, 30, 0.85);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255,255,255,0.15);
                z-index: 100;
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 12px;
            }

            .deck-info { width: auto; gap: 12px; }
            .deck-art { width: 48px; height: 48px; border-radius: 8px; }
            .q-title { font-size: 0.9rem; }
            .q-artist { font-size: 0.75rem; }

            .deck-controls { 
                width: auto; 
                flex-direction: row; 
                justify-content: flex-end;
            }
            .progress-container { display: none; } 
            .deck-buttons { gap: 16px; }
            .deck-btn { display: none; } 
            .deck-btn.main { display: flex; width: 44px; height: 44px; } 
            
            .deck-volume { display: none; }

            .mobile-vibes {
                display: flex;
                gap: 8px;
                padding: 0 0 20px 0;
                overflow-x: auto;
                width: 100%;
                -webkit-overflow-scrolling: touch;
            }
            .mobile-vibes::-webkit-scrollbar { display: none; }
        }
        @media (min-width: 901px) {
            .mobile-track-time { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="ambient-glow" id="bg-glow"></div>
    <div class="noise-overlay"></div>

    <div id="app-container">
        
        <!-- SIDEBAR -->
        <nav class="sidebar glass-panel">
            <div class="brand">
                <div class="brand-icon"></div>
                <span>Lofi.fm</span>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item active">
                    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    Start Radio
                </li>
                <li class="nav-item">
                    <a href="https://mircoaurelio.github.io/ambient/" target="_blank" rel="noopener noreferrer" class="nav-link">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
                        Focus Mode
                    </a>
                </li>
            </ul>

           
        </nav>

        <!-- MAIN STAGE -->
        <main class="main-stage glass-panel">
            <div class="stage-header">
                <div class="live-tag"><div class="live-dot"></div> LIVE BROADCAST</div>
                <div class="badge">Pro Member</div>
            </div>

            <div class="mobile-vibes" style="display: none;"></div>

            <div class="hero-layout">
                <div class="album-art-wrapper">
                    <div class="album-art-container">
                        <canvas id="visualizer"></canvas>
                    </div>
                    <div class="mobile-track-time">
                        <span id="mobile-time-current">0:00</span>
                        <div class="prog-track mobile-prog"><div class="prog-fill" id="mobile-progress-bar"></div></div>
                        <span id="mobile-time-total">--:--</span>
                    </div>
                </div>
                <div class="track-details">
                    <!-- Cleaned up mobile list -->
                    <div class="mobile-vibes-list" style="display:none; overflow-x:auto; gap:8px; margin-bottom:16px; width:100%; white-space:nowrap;">
                         <!-- Intentionally empty per request -->
                    </div>

                    <div class="meta-badges">
                        <span class="badge accent" id="style-badge">Classic</span>
                        <span class="badge" id="mood-badge">Neutral</span>
                        <span class="badge" id="bpm-badge">80 BPM</span>
                    </div>
                    <h1 id="playlist-title">Tap Play to Start</h1>
                    <div id="playlist-artist" class="playlist-artist" style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 16px; display: none;">—</div>
                    <div class="action-row">
                        <button class="play-btn-lg" id="playBtn">
                            <svg class="icon-play show-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                        <span id="play-prompt" style="font-weight: 600; color: var(--text-muted); font-size: 0.9rem;">Press play to start the radio</span>
                    </div>
                </div>
            </div>

            <div class="queue-section" id="queue-container">
            </div>
        </main>

        <!-- PLAYER DECK -->
        <footer class="player-deck glass-panel">
            <div class="deck-info">
                <div class="deck-art">
                    <!-- Icon Placeholder -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="rgba(255,255,255,0.5)"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>
                </div>
                <div>
                    <div class="q-title" id="bar-title">Tap play to start</div>
                    <div class="q-artist" id="bar-artist">Lofi.fm</div>
                </div>
            </div>

            <div class="deck-controls">
                <div class="deck-buttons">
                    <button class="deck-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button class="deck-btn main" id="barPlayBtn">
                        <svg class="icon-play show-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        <svg class="icon-pause" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <!-- Next button hidden on mobile via CSS deck-btn class logic -->
                    <button class="deck-btn" id="nextBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                </div>
                <div class="progress-container">
                    <span id="time-current">0:00</span>
                    <div class="prog-track"><div class="prog-fill" id="progress-bar"></div></div>
                    <span id="time-total">--:--</span>
                </div>
            </div>

            <div class="deck-volume">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#666"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </div>
        </footer>

    </div>

<script>
    /**
     * LOFI.FM AUDIO ENGINE v9.0 — Hit-only generation, famous progressions & patterns
     */

    function mulberry32(a) {
        return function() {
          var t = a += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }

    const MIN_TRACK_MS = 95 * 1000; 
    const MAX_TRACK_MS = 180 * 1000;
    
    let currentRNG = null; 
    let isTransitioning = false;
    let isInitializing = false; 

    // --- METADATA (expanded for more variety so tracks feel less samey) ---
    const TITLES_A = ["Sun", "Urban", "Funky", "Cosmic", "Sunday", "Coffee", "Neon", "Happy", "Golden", "Floating", "Velvet", "Soft", "Early", "Pink", "Blue", "Warm", "Safe", "Breeze", "Mellow", "Calm", "Cozy", "Sunny", "Clear", "Bright"];
    const TITLES_B = ["Dreams", "Day", "Loop", "Groove", "Thoughts", "Vibes", "Window", "Clouds", "Station", "Memories", "Soul", "Waves", "Pages", "Lights", "Hours", "Side", "Tape", "Room", "Sky", "Mood", "Beat", "Morning", "Glow", "Light"];
    const ARTISTS_A = ["Lo-Fi", "Chill", "Beats", "Bedroom", "Analog", "Digital", "Sleepy", "Mellow", "Jazz", "Retro", "Lazy", "Quiet", "Soft", "Deep", "Warm", "Cosmic", "Nostalgic", "Urban", "Velvet", "Blue", "Golden", "Stardust"];
    const ARTISTS_B = ["Boy", "Girl", "Project", "Collective", "Hop", "Cat", "Smith", "Waves", "FM", "Tapes", "Corner", "Society", "Lab", "Room", "Band", "Radio", "Sounds", "Beats", "Crew", "Studio", "Arcade", "Café", "Lounge", "Atelier"];

    // --- CONFIG ---
    const NOTES = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];
    const MOOD_SCALES = { 'Chill': ['Dorian', 'Major'], 'Uplifting': ['Major', 'Lydian'], 'Groovy': ['Mixolydian', 'Dorian'], 'Dreamy': ['Lydian', 'Major'], 'Warm': ['Major', 'Mixolydian'] };
    const MODES = { 'Minor': [0, 2, 3, 5, 7, 8, 10], 'Dorian': [0, 2, 3, 5, 7, 9, 10], 'Major': [0, 2, 4, 5, 7, 9, 11], 'Lydian': [0, 2, 4, 6, 7, 9, 11], 'Phrygian': [0, 1, 3, 5, 7, 8, 10], 'Mixolydian': [0, 2, 4, 5, 7, 9, 10] };

    // --- Classic lo-fi hip hop / chill hop drums only (6 iconic patterns)
    const DRUM_LOOPS = {
        'BoomBap': [1,0,0,1, 2,0,0,0, 0,1,0,0, 2,0,0,0],
        'Dilla': [1,0,0,0, 2,0,0,1, 0,0,1,0, 2,0,0,0],
        'Lofi': [1,0,0,1, 2,0,0,0, 1,0,0,0, 2,0,0,0],
        'ChillHop': [1,0,0,0, 2,0,0,0, 0,1,0,0, 2,0,0,1],
        'JazzHop': [1,0,0,1, 2,0,0,0, 0,1,0,0, 2,0,0,1],
        'Backbeat': [1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0]
    };
    // --- LOFI BASS PATTERNS ONLY (~50). 0=rest, 1=root, 2=fifth, 3=root up (16-step)
    const BASS_PATTERNS = {
        'RootQuarter': [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0], 'RootQuarter2': [1,0,1,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
        'RootFifth': [1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0], 'RootFifth2': [1,0,0,0, 2,0,0,0, 2,0,0,0, 1,0,0,0],
        'RootFifth3': [1,0,2,0, 1,0,0,0, 1,0,2,0, 2,0,0,0], 'RootFifth4': [1,0,0,0, 2,0,0,0, 1,0,2,0, 1,0,0,0],
        'Funk': [1,0,2,0, 0,1,0,0, 1,0,0,2, 0,0,1,0], 'Funk2': [1,0,0,2, 0,1,0,0, 1,0,2,0, 0,0,1,0],
        'Funk3': [0,1,0,2, 1,0,0,0, 0,1,0,0, 2,0,1,0], 'Funk4': [1,0,2,0, 1,0,0,2, 0,1,0,0, 1,0,0,0],
        'Walking': [1,0,2,0, 1,0,2,0, 1,0,2,0, 1,0,2,0], 'Walking2': [1,0,0,2, 1,0,2,0, 1,0,0,2, 1,0,0,0],
        'Walking3': [2,0,1,0, 2,0,1,0, 1,0,2,0, 1,0,0,0], 'Walking4': [1,0,2,0, 2,0,1,0, 1,0,2,0, 2,0,1,0],
        'Bounce': [1,0,0,1, 2,0,0,0, 1,0,0,2, 0,0,0,0], 'Bounce2': [1,0,0,0, 2,0,1,0, 1,0,0,2, 0,0,0,0],
        'Bounce3': [1,0,1,0, 2,0,0,0, 1,0,0,0, 2,0,0,0], 'Bounce4': [1,0,0,1, 0,0,2,0, 1,0,0,0, 2,0,0,0],
        'Sparse': [1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0], 'Sparse2': [1,0,0,0, 2,0,0,0, 0,0,0,0, 0,0,0,0],
        'Sparse3': [1,0,0,0, 0,0,0,0, 2,0,0,0, 1,0,0,0], 'Sparse4': [0,0,1,0, 0,0,2,0, 0,0,1,0, 0,0,0,0],
        'Pedal': [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0], 'Pedal2': [1,0,0,1, 1,0,0,0, 1,0,0,1, 1,0,0,0],
        'Pedal3': [1,1,0,0, 1,0,0,1, 1,0,0,0, 1,0,0,0], 'Syncopated': [0,1,0,0, 2,0,1,0, 0,1,0,2, 0,0,1,0],
        'Syncopated2': [1,0,0,2, 0,1,0,0, 2,0,1,0, 0,0,0,1], 'Syncopated3': [0,0,1,0, 1,0,0,2, 0,1,0,0, 2,0,1,0],
        'Lofi': [1,0,0,0, 1,0,0,0, 2,0,0,0, 1,0,0,0], 'Lofi2': [1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0],
        'Lofi3': [1,0,0,0, 0,0,1,0, 2,0,0,0, 1,0,0,0], 'Lofi4': [1,0,2,0, 0,0,0,0, 1,0,0,0, 2,0,0,0],
        'Lofi5': [1,0,0,0, 2,0,0,0, 1,0,2,0, 0,0,0,0], 'Jazzy': [1,0,2,0, 1,0,0,2, 1,0,2,0, 2,0,1,0],
        'Jazzy2': [1,0,0,2, 2,0,1,0, 1,0,2,0, 0,0,1,0], 'Jazzy3': [2,0,1,0, 1,0,2,0, 1,0,0,2, 1,0,0,0],
        'Chill': [1,0,0,0, 1,0,0,0, 1,0,0,0, 2,0,0,0], 'Chill2': [1,0,0,0, 0,0,0,0, 2,0,0,0, 1,0,0,0],
        'Chill3': [1,0,0,0, 2,0,0,0, 0,0,1,0, 0,0,0,0], 'Minimal': [1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0],
        'Minimal2': [1,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0], 'RootUp': [1,0,0,0, 3,0,0,0, 1,0,0,0, 3,0,0,0],
        'RootUp2': [1,0,3,0, 1,0,0,0, 3,0,1,0, 0,0,0,0], 'Study': [1,0,0,0, 2,0,0,0, 1,0,0,0, 0,0,0,0],
        'Study2': [1,0,0,0, 0,0,0,0, 2,0,0,0, 1,0,0,0], 'Nocturnal': [1,0,0,0, 0,0,1,0, 0,0,0,0, 2,0,0,0],
        'Vintage': [1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0], 'Vintage2': [1,0,2,0, 1,0,0,0, 1,0,2,0, 1,0,0,0]
    };
    // --- LOFI HI-HAT PATTERNS. 0=rest, 1=closed hit, 2=ghost (soft), 3=open hat (16-step)
    const HIHAT_PATTERNS = {
        'Straight8':  [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
        'Swing8':     [1,0,0,1, 1,0,0,1, 1,0,0,1, 1,0,0,1],
        'Groovy':     [1,0,2,0, 1,0,2,1, 1,0,2,0, 1,0,2,0],
        'Sparse4':    [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
        'Offbeat':    [0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0],
        'Dilla':      [1,0,2,0, 1,0,0,2, 1,0,2,0, 0,2,0,1],
        'Ghosty':     [1,0,2,0, 1,0,2,0, 1,0,2,0, 1,0,2,0],
        'Rolling':    [1,2,1,0, 1,2,0,1, 1,2,1,0, 1,0,2,1],
        'WithOpen':   [1,0,1,0, 1,0,3,0, 1,0,1,0, 1,0,3,0],
        'Minimal':    [1,0,0,0, 0,0,1,0, 1,0,0,0, 0,0,1,0],
        'Lazy':       [0,0,1,0, 0,0,0,1, 0,0,1,0, 0,0,0,0],
        'Tight16':    [1,2,1,2, 1,2,1,2, 1,2,1,2, 1,2,1,2]
    };
    // --- LOFI HIT PROGRESSIONS ONLY (~80 major + ~80 minor). Soul, jazz, nostalgic.
    const FAMOUS_PROGRESSIONS = {
        major: [
            [1, 5, 6, 4], [1, 4, 5, 1], [1, 6, 4, 5], [4, 1, 5, 6], [1, 3, 4, 5], [2, 5, 1, 1], [1, 4, 1, 5], [6, 4, 1, 5],
            [1, 6, 2, 5], [2, 5, 1, 6], [4, 5, 1, 1], [1, 4, 6, 5], [6, 2, 5, 1], [3, 6, 4, 1], [1, 5, 1, 4], [4, 1, 1, 5],
            [1, 4, 2, 5], [5, 1, 4, 1], [1, 3, 6, 4], [6, 4, 2, 5], [2, 5, 6, 4], [1, 5, 4, 1], [4, 5, 6, 1], [1, 6, 4, 1],
            [3, 6, 2, 5], [1, 4, 3, 5], [6, 1, 4, 5], [2, 5, 4, 1], [5, 6, 4, 1], [1, 1, 4, 5], [4, 1, 6, 5], [1, 2, 5, 1],
            [6, 4, 5, 1], [1, 4, 5, 6], [5, 4, 1, 6], [3, 4, 5, 1], [1, 6, 5, 4], [4, 6, 1, 5], [2, 5, 1, 4], [1, 5, 6, 1],
            [6, 1, 5, 4], [5, 1, 6, 4], [1, 4, 6, 1], [4, 1, 4, 5], [1, 3, 4, 1], [6, 5, 4, 1], [1, 6, 3, 4], [2, 5, 6, 1],
            [4, 5, 1, 4], [1, 5, 4, 6], [3, 4, 1, 5], [6, 4, 1, 1], [1, 4, 5, 4], [5, 1, 4, 6], [1, 2, 5, 6], [4, 6, 5, 1],
            [1, 6, 4, 2], [2, 5, 4, 6], [1, 3, 5, 4], [6, 1, 4, 1], [5, 4, 6, 1], [1, 4, 1, 6], [4, 5, 6, 4], [1, 5, 1, 6],
            [3, 5, 1, 4], [6, 2, 5, 4], [1, 6, 1, 4], [4, 1, 5, 1], [1, 2, 4, 5], [5, 6, 1, 4], [2, 5, 1, 5], [1, 4, 2, 1],
            [6, 4, 4, 5], [4, 2, 5, 1], [1, 5, 6, 4], [3, 1, 4, 5], [1, 6, 5, 1], [5, 1, 1, 4], [4, 6, 1, 1], [1, 3, 2, 5],
            [6, 5, 1, 4], [2, 4, 5, 1], [1, 4, 4, 5], [4, 5, 2, 5], [1, 5, 2, 5], [5, 4, 1, 1], [6, 1, 2, 5], [1, 2, 6, 4],
            [4, 1, 2, 5], [3, 4, 6, 5], [1, 6, 2, 1], [6, 4, 5, 4], [1, 4, 5, 2], [2, 5, 4, 5], [4, 1, 6, 4], [1, 5, 3, 4],
            [5, 1, 2, 5], [6, 2, 4, 5], [1, 3, 6, 5], [4, 5, 4, 1], [1, 2, 1, 4], [6, 1, 4, 4], [1, 4, 3, 1], [2, 6, 5, 1],
            [5, 6, 1, 1], [1, 5, 4, 5], [4, 6, 4, 5], [3, 2, 5, 1], [1, 6, 6, 4], [6, 5, 2, 5], [4, 2, 1, 5], [1, 1, 6, 4]
        ],
        minor: [
            [1, 7, 6, 5], [6, 4, 1, 5], [1, 6, 2, 5], [1, 6, 4, 5], [4, 5, 1, 6], [2, 5, 1, 6], [1, 5, 6, 3], [4, 5, 3, 6],
            [1, 4, 1, 5], [1, 7, 4, 5], [6, 1, 4, 5], [1, 6, 5, 4], [4, 1, 5, 6], [2, 5, 6, 1], [1, 5, 4, 6], [3, 6, 4, 1],
            [1, 4, 6, 5], [7, 6, 5, 1], [1, 6, 4, 1], [6, 4, 5, 1], [4, 5, 6, 3], [1, 5, 1, 4], [4, 1, 6, 5], [2, 5, 4, 1],
            [1, 7, 5, 6], [6, 1, 5, 4], [1, 3, 4, 5], [4, 6, 1, 5], [1, 6, 3, 4], [5, 1, 6, 4], [6, 5, 4, 1], [1, 4, 5, 1],
            [4, 1, 1, 5], [1, 5, 6, 1], [7, 4, 1, 5], [6, 4, 1, 1], [1, 2, 5, 6], [4, 5, 1, 4], [1, 6, 2, 1], [2, 5, 1, 4],
            [1, 4, 2, 5], [6, 2, 5, 1], [1, 7, 6, 1], [4, 1, 4, 5], [1, 5, 4, 1], [6, 4, 2, 5], [4, 5, 4, 1], [1, 3, 6, 4],
            [1, 6, 5, 1], [5, 6, 1, 4], [1, 4, 6, 1], [7, 1, 6, 5], [6, 1, 4, 1], [1, 5, 2, 5], [4, 6, 5, 1], [2, 5, 6, 4],
            [1, 2, 5, 1], [6, 5, 1, 5], [1, 7, 4, 1], [4, 1, 5, 1], [1, 6, 4, 2], [5, 4, 1, 6], [6, 4, 5, 4], [1, 4, 1, 6],
            [4, 5, 6, 1], [1, 5, 1, 6], [7, 6, 1, 5], [6, 1, 2, 5], [1, 3, 5, 6], [4, 2, 5, 1], [1, 6, 1, 4], [2, 5, 4, 6],
            [1, 4, 5, 6], [6, 4, 1, 4], [1, 5, 6, 5], [4, 1, 2, 5], [1, 7, 1, 6], [5, 1, 4, 5], [6, 5, 4, 6], [1, 2, 6, 5],
            [4, 5, 2, 5], [1, 6, 6, 4], [7, 4, 5, 1], [6, 2, 5, 4], [1, 4, 4, 5], [4, 6, 1, 1], [1, 5, 4, 5], [3, 6, 1, 5],
            [1, 3, 6, 5], [6, 4, 6, 5], [1, 4, 2, 1], [5, 6, 4, 1], [1, 7, 5, 1], [4, 5, 1, 2], [6, 1, 5, 1], [1, 2, 4, 5],
            [4, 1, 6, 1], [1, 5, 3, 6], [7, 1, 4, 5], [6, 5, 1, 4], [1, 6, 4, 5], [4, 2, 1, 6], [1, 4, 6, 4], [2, 5, 1, 1],
            [1, 5, 1, 5], [6, 1, 6, 4], [4, 5, 4, 6], [1, 3, 4, 6], [1, 7, 6, 4], [5, 1, 6, 1], [6, 4, 1, 2], [1, 2, 5, 4],
            [4, 6, 5, 4], [1, 6, 2, 4], [7, 5, 6, 1], [6, 1, 4, 5], [1, 4, 5, 4], [4, 1, 4, 1], [1, 5, 6, 2], [3, 4, 5, 6],
            [1, 2, 1, 5], [6, 5, 2, 5], [4, 5, 6, 5], [1, 7, 4, 6], [1, 6, 5, 6], [5, 4, 6, 1], [6, 2, 1, 5], [1, 4, 2, 6],
            [4, 1, 5, 4], [1, 5, 4, 1], [7, 6, 4, 5], [6, 4, 6, 1], [1, 3, 2, 5], [4, 2, 5, 6], [1, 6, 1, 5], [2, 6, 1, 5],
            [1, 4, 1, 4], [6, 1, 1, 4], [4, 6, 4, 1], [1, 5, 2, 1], [1, 7, 1, 4], [5, 6, 1, 5], [6, 5, 1, 1], [1, 2, 4, 1],
            [4, 5, 1, 5], [1, 6, 4, 6], [7, 4, 1, 6], [6, 2, 4, 1], [1, 4, 5, 2], [4, 1, 2, 1], [1, 5, 1, 1], [3, 1, 6, 5],
            [1, 3, 5, 4], [6, 4, 5, 6], [4, 5, 2, 1], [1, 7, 2, 5], [1, 6, 6, 5], [5, 1, 5, 6], [6, 1, 2, 1], [1, 2, 6, 1],
            [4, 1, 2, 6], [1, 5, 4, 4], [7, 1, 6, 4], [6, 5, 4, 5], [1, 4, 6, 2], [4, 6, 2, 5], [1, 6, 2, 6], [2, 5, 2, 5],
            [1, 4, 4, 1], [6, 1, 5, 6], [4, 5, 4, 5], [1, 7, 6, 6], [1, 5, 3, 1], [5, 4, 1, 4], [6, 4, 2, 1], [1, 2, 1, 6],
            [4, 2, 1, 5], [1, 6, 3, 5], [7, 5, 1, 6], [6, 2, 1, 4], [1, 4, 2, 4], [4, 1, 6, 2], [1, 5, 6, 6], [3, 6, 2, 5],
            [1, 3, 6, 1], [6, 5, 6, 1], [4, 1, 5, 2], [1, 7, 5, 4], [1, 6, 1, 6], [5, 6, 4, 5], [6, 1, 4, 6], [1, 2, 5, 1],
            [4, 5, 6, 2], [1, 5, 2, 1], [7, 4, 6, 5], [6, 4, 1, 3], [1, 4, 3, 5], [4, 6, 5, 6], [1, 6, 5, 2], [2, 5, 4, 1]
        ]
    };
    // --- LOFI HOOK CONTOURS ONLY (~90). Scale degrees 0..6. Simple, catchy, repetitive with variation.
    const MOTIF_CONTOURS = [
        [0, 1, 2, 3, 2, 1, 0], [0, 2, 0, 2, 3, 2, 0], [1, 1, 2, 2, 3, 2, 1, 0], [0, 1, 2, 3, 3, 2, 1], [2, 1, 0, 1, 2, 3, 2],
        [0, 2, 4, 2, 0], [3, 2, 1, 0, 1, 2], [0, 0, 2, 3, 2, 0], [1, 2, 3, 4, 3, 2, 1], [0, 1, 0, 2, 0, 1, 0],
        [2, 1, 0, 1, 2, 1, 0], [0, 2, 3, 2, 0], [1, 2, 1, 2, 3, 2, 1], [0, 1, 2, 1, 0], [3, 2, 3, 2, 1, 0],
        [0, 1, 2, 2, 1, 0], [1, 0, 1, 2, 3, 2], [0, 2, 1, 2, 0], [2, 3, 2, 1, 0, 1], [0, 0, 1, 2, 1, 0],
        [1, 2, 3, 2, 1, 0, 1], [0, 3, 2, 1, 0], [2, 0, 2, 3, 2, 0], [0, 1, 2, 3, 2, 1], [1, 1, 0, 1, 2, 1],
        [0, 2, 0, 1, 0], [3, 2, 1, 2, 1, 0], [0, 1, 2, 0, 1, 2], [1, 2, 0, 2, 1, 0], [0, 2, 3, 3, 2, 0],
        [2, 1, 2, 1, 0], [0, 1, 0, 1, 2, 3], [1, 0, 2, 0, 1, 0], [0, 3, 2, 1, 2, 0], [2, 1, 0, 2, 1, 0],
        [0, 1, 2, 1, 2, 1, 0], [1, 2, 1, 0, 1, 2], [0, 0, 0, 2, 3, 2], [2, 3, 2, 1, 0], [0, 2, 1, 0, 2, 0],
        [1, 1, 2, 1, 1, 0], [0, 1, 2, 2, 0], [3, 1, 2, 1, 0], [0, 2, 2, 0, 1, 0], [1, 2, 3, 2, 0, 1],
        [0, 1, 1, 2, 1, 0], [2, 0, 1, 0, 2, 1], [0, 3, 2, 0, 1, 0], [1, 0, 1, 2, 2, 1], [0, 2, 1, 1, 2, 0],
        [1, 2, 2, 1, 0, 0], [0, 1, 2, 0, 2, 1], [2, 1, 0, 0, 1, 2], [0, 0, 1, 2, 2, 1, 0], [1, 2, 0, 1, 2, 0],
        [0, 2, 1, 2, 3, 2, 0], [1, 0, 2, 1, 0, 1], [0, 1, 0, 2, 1, 2, 0], [2, 3, 4, 3, 2, 1], [0, 0, 1, 0, 2, 0],
        [1, 2, 1, 0, 2, 1, 0], [0, 2, 3, 2, 1, 0, 1], [1, 1, 2, 0, 2, 1], [0, 1, 2, 3, 1, 0], [2, 0, 2, 0, 1, 0],
        [0, 3, 2, 1, 0, 1, 2], [1, 2, 3, 1, 2, 0], [0, 1, 2, 1, 0, 2, 0], [2, 1, 0, 1, 0], [0, 0, 2, 0, 1, 2],
        [1, 0, 1, 0, 2, 1, 0], [0, 2, 1, 3, 2, 0], [1, 2, 3, 2, 1, 2, 0], [0, 1, 2, 0, 1, 0], [2, 1, 2, 0, 1, 0],
        [0, 1, 0, 0, 2, 1, 0], [1, 1, 0, 2, 1, 0], [0, 2, 0, 3, 2, 1, 0], [2, 2, 1, 0, 1, 0], [0, 1, 2, 1, 1, 0],
        [1, 0, 2, 2, 1, 0], [0, 3, 2, 2, 1, 0], [1, 2, 1, 2, 0, 0], [0, 0, 2, 1, 2, 0], [2, 1, 0, 2, 0, 1],
        [0, 1, 2, 3, 0, 1, 0], [1, 2, 0, 0, 1, 2, 0], [0, 2, 1, 0, 1, 0], [3, 2, 1, 0, 0, 1], [0, 1, 1, 0, 2, 1],
        [1, 0, 0, 1, 2, 1, 0], [0, 2, 2, 1, 0, 1], [1, 2, 0, 2, 1, 2, 0], [0, 1, 2, 2, 1, 1, 0], [2, 0, 1, 2, 1, 0],
        [0, 0, 1, 2, 0, 1, 0], [1, 1, 2, 3, 2, 0], [0, 2, 3, 1, 2, 0], [2, 1, 0, 1, 2, 0], [0, 1, 0, 2, 0, 1, 2],
        [1, 2, 1, 0, 0, 1, 0], [0, 3, 1, 2, 1, 0], [1, 0, 1, 2, 0, 2, 0], [0, 2, 1, 2, 0, 0], [2, 3, 2, 0, 1, 0],
        [0, 1, 2, 0, 0, 1, 0], [1, 2, 2, 0, 1, 0], [0, 0, 2, 1, 0, 2, 0], [1, 0, 2, 1, 2, 0], [0, 2, 0, 1, 2, 1, 0],
        [1, 1, 0, 1, 0, 2, 0], [0, 1, 3, 2, 1, 0], [2, 0, 0, 1, 2, 0], [0, 1, 2, 1, 0, 0, 1], [1, 2, 0, 1, 0, 1, 0]
    ];

    // --- LOFI STYLES ONLY. BPM 55-92, swing, bit-crush, 7ths where noted.
    const STYLES = {
        'Chill Hop': { bpmRange: [78, 90], swing: 0.015, drumDensity: 0.6, bitCrush: 0, hasLead: true, isGuitar: false, color: '#e07c54' },
        'Classic': { bpmRange: [68, 78], swing: 0.01, drumDensity: 0.4, bitCrush: 4, hasLead: true, isGuitar: false, color: '#d4a055' },
        'Sleepy': { bpmRange: [52, 64], swing: 0.005, drumDensity: 0.1, bitCrush: 8, hasLead: false, isGuitar: false, color: '#5b7c99' },
        'Jazzy': { bpmRange: [70, 86], swing: 0.02, drumDensity: 0.5, bitCrush: 2, hasLead: true, isGuitar: false, color: '#7c5cbf' },
        'Minimal': { bpmRange: [58, 70], swing: 0.005, drumDensity: 0.2, bitCrush: 6, hasLead: false, isGuitar: false, color: '#6b7280' },
        'Study': { bpmRange: [72, 82], swing: 0.008, drumDensity: 0.35, bitCrush: 4, hasLead: true, isGuitar: false, color: '#84a98c' },
        'Twilight': { bpmRange: [64, 76], swing: 0.01, drumDensity: 0.28, bitCrush: 5, hasLead: true, isGuitar: false, color: '#7c8ba3' },
        'Rainy': { bpmRange: [62, 74], swing: 0.008, drumDensity: 0.3, bitCrush: 5, hasLead: true, isGuitar: false, color: '#6b8cae' },
        'Vintage': { bpmRange: [70, 80], swing: 0.012, drumDensity: 0.45, bitCrush: 4, hasLead: true, isGuitar: false, color: '#c9a959' },
        'Neo-Soul': { bpmRange: [74, 88], swing: 0.02, drumDensity: 0.55, bitCrush: 2, hasLead: true, isGuitar: false, color: '#b56576' },
        'Soft': { bpmRange: [64, 76], swing: 0.008, drumDensity: 0.28, bitCrush: 5, hasLead: true, isGuitar: false, color: '#a8b5a0' },
        'Warm': { bpmRange: [72, 84], swing: 0.01, drumDensity: 0.5, bitCrush: 3, hasLead: true, isGuitar: false, color: '#c4785a' },
        'Mellow': { bpmRange: [66, 78], swing: 0.012, drumDensity: 0.4, bitCrush: 4, hasLead: true, isGuitar: false, color: '#9ca777' },
        'Cozy': { bpmRange: [60, 72], swing: 0.01, drumDensity: 0.32, bitCrush: 5, hasLead: true, isGuitar: false, color: '#8b7355' },
        'Sunrise': { bpmRange: [70, 82], swing: 0.01, drumDensity: 0.35, bitCrush: 4, hasLead: true, isGuitar: false, color: '#f4a261' }
    };

    // --- LOFI SOUND BANKS (10x variation). Keys, pad, bass, lead, effects, drums — hit tones only.
    // Keys: warm sine/triangle only (no square — too harsh). Short sustain for rhythmic hip-hop chords.
    const KEY_PATCHES = [
        { oscillator: { type: 'fatsine' }, envelope: { attack: 0.08, decay: 0.25, sustain: 0.28, release: 0.7 }, volume: -24, detune: 0 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.12, decay: 0.3, sustain: 0.3, release: 0.9 }, volume: -23, detune: 0 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.22, release: 0.6 }, volume: -25, detune: 0 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.06, decay: 0.22, sustain: 0.24, release: 0.7 }, volume: -25, detune: 0 },
        { oscillator: { type: 'fatsine' }, envelope: { attack: 0.15, decay: 0.35, sustain: 0.3, release: 1.0 }, volume: -24, detune: 2 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.02, decay: 0.18, sustain: 0.18, release: 0.5 }, volume: -23, detune: -1 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.2, decay: 0.4, sustain: 0.32, release: 1.2 }, volume: -25, detune: 0 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.04, decay: 0.28, sustain: 0.25, release: 0.8 }, volume: -26, detune: 1 },
        { oscillator: { type: 'fatsine' }, envelope: { attack: 0.1, decay: 0.32, sustain: 0.28, release: 0.9 }, volume: -23, detune: 0 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.18, decay: 0.38, sustain: 0.3, release: 1.0 }, volume: -24, detune: -2 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.03, decay: 0.2, sustain: 0.18, release: 0.6 }, volume: -25, detune: 0 },
        { oscillator: { type: 'fatsine' }, envelope: { attack: 0.14, decay: 0.3, sustain: 0.26, release: 0.9 }, volume: -25, detune: 0 }
    ];
    // Pads: quiet background warmth only (no square, low sustain, short release — NOT a drone)
    const PAD_PATCHES = [
        { oscillator: { type: 'sine' }, envelope: { attack: 1.2, decay: 0.8, sustain: 0.35, release: 1.6 }, volume: -29 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.9, decay: 0.7, sustain: 0.3, release: 1.4 }, volume: -28 },
        { oscillator: { type: 'sine' }, envelope: { attack: 1.5, decay: 1.0, sustain: 0.38, release: 1.8 }, volume: -30 },
        { oscillator: { type: 'fatsine' }, envelope: { attack: 1.1, decay: 0.8, sustain: 0.32, release: 1.5 }, volume: -29 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.6, decay: 0.6, sustain: 0.25, release: 1.3 }, volume: -28 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 1.4, decay: 0.9, sustain: 0.36, release: 1.7 }, volume: -30 },
        { oscillator: { type: 'sine' }, envelope: { attack: 1.2, decay: 0.85, sustain: 0.3, release: 1.5 }, volume: -31 },
        { oscillator: { type: 'sine' }, envelope: { attack: 1.0, decay: 0.7, sustain: 0.28, release: 1.3 }, volume: -28 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 1.6, decay: 1.0, sustain: 0.38, release: 2.0 }, volume: -29 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.7, decay: 0.5, sustain: 0.22, release: 1.1 }, volume: -27 },
        { oscillator: { type: 'fatsine' }, envelope: { attack: 1.3, decay: 0.8, sustain: 0.32, release: 1.6 }, volume: -29 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.9, decay: 0.7, sustain: 0.28, release: 1.5 }, volume: -28 }
    ];
    const BASS_PATCHES = [
        { oscillator: { type: 'sine' }, envelope: { attack: 0.04, decay: 0.18, sustain: 0.92, release: 1 }, volume: -12 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.06, decay: 0.2, sustain: 0.88, release: 1.1 }, volume: -14 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.02, decay: 0.15, sustain: 0.95, release: 0.9 }, volume: -11 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.05, decay: 0.22, sustain: 0.85, release: 1.2 }, volume: -13 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.08, decay: 0.25, sustain: 0.82, release: 1.15 }, volume: -13 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.03, decay: 0.2, sustain: 0.9, release: 1.05 }, volume: -12 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.07, decay: 0.28, sustain: 0.8, release: 1.25 }, volume: -14 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.04, decay: 0.18, sustain: 0.88, release: 0.95 }, volume: -12 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.06, decay: 0.24, sustain: 0.83, release: 1.1 }, volume: -15 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.05, decay: 0.19, sustain: 0.9, release: 1 }, volume: -13 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.03, decay: 0.16, sustain: 0.92, release: 0.88 }, volume: -12 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.09, decay: 0.3, sustain: 0.78, release: 1.3 }, volume: -14 }
    ];
    // Lead: very quiet background accent (no square — sine/triangle only, well behind the beat)
    const LEAD_PATCHES = [
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.04, decay: 0.18, sustain: 0.12, release: 0.7 }, volume: -32 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.06, decay: 0.22, sustain: 0.15, release: 0.8 }, volume: -31 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.02, decay: 0.15, sustain: 0.1, release: 0.6 }, volume: -33 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.12, release: 0.75 }, volume: -32 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.08, decay: 0.25, sustain: 0.18, release: 0.9 }, volume: -31 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.03, decay: 0.2, sustain: 0.11, release: 0.65 }, volume: -32 },
        { oscillator: { type: 'fatsine' }, envelope: { attack: 0.05, decay: 0.19, sustain: 0.14, release: 0.75 }, volume: -31 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.04, decay: 0.16, sustain: 0.1, release: 0.6 }, volume: -33 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.07, decay: 0.24, sustain: 0.16, release: 0.85 }, volume: -31 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.03, decay: 0.18, sustain: 0.1, release: 0.6 }, volume: -34 },
        { oscillator: { type: 'triangle' }, envelope: { attack: 0.06, decay: 0.21, sustain: 0.14, release: 0.75 }, volume: -32 },
        { oscillator: { type: 'sine' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.12, release: 0.7 }, volume: -32 }
    ];
    // Effects: gentle and warm. Tremolo/vibrato kept very subtle to avoid robotic wobble.
    const EFFECT_PRESETS = [
        { reverbDecay: 0.28, delayWet: 0.10, chorusWet: 0.18, filterMin: 550, filterMax: 1500, tremoloWet: 0.04, vibratoWet: 0.02 },
        { reverbDecay: 0.32, delayWet: 0.14, chorusWet: 0.22, filterMin: 580, filterMax: 1600, tremoloWet: 0.06, vibratoWet: 0.025 },
        { reverbDecay: 0.22, delayWet: 0.06, chorusWet: 0.14, filterMin: 500, filterMax: 1300, tremoloWet: 0.02, vibratoWet: 0.015 },
        { reverbDecay: 0.36, delayWet: 0.16, chorusWet: 0.24, filterMin: 600, filterMax: 1700, tremoloWet: 0.08, vibratoWet: 0.03 },
        { reverbDecay: 0.25, delayWet: 0.08, chorusWet: 0.16, filterMin: 520, filterMax: 1400, tremoloWet: 0.03, vibratoWet: 0.02 },
        { reverbDecay: 0.34, delayWet: 0.12, chorusWet: 0.20, filterMin: 620, filterMax: 1750, tremoloWet: 0.06, vibratoWet: 0.025 },
        { reverbDecay: 0.28, delayWet: 0.10, chorusWet: 0.18, filterMin: 540, filterMax: 1500, tremoloWet: 0.04, vibratoWet: 0.02 },
        { reverbDecay: 0.20, delayWet: 0.05, chorusWet: 0.12, filterMin: 480, filterMax: 1200, tremoloWet: 0.02, vibratoWet: 0.01 },
        { reverbDecay: 0.38, delayWet: 0.18, chorusWet: 0.26, filterMin: 640, filterMax: 1800, tremoloWet: 0.08, vibratoWet: 0.03 },
        { reverbDecay: 0.24, delayWet: 0.08, chorusWet: 0.16, filterMin: 510, filterMax: 1350, tremoloWet: 0.03, vibratoWet: 0.02 },
        { reverbDecay: 0.30, delayWet: 0.10, chorusWet: 0.18, filterMin: 560, filterMax: 1550, tremoloWet: 0.05, vibratoWet: 0.02 },
        { reverbDecay: 0.22, delayWet: 0.06, chorusWet: 0.14, filterMin: 490, filterMax: 1250, tremoloWet: 0.02, vibratoWet: 0.015 }
    ];
    const DRUM_TONES = [
        { kickDecay: 0.35, snareDecay: 0.16, hihatFreq: 120, hihatDecay: 0.035 },
        { kickDecay: 0.34, snareDecay: 0.15, hihatFreq: 125, hihatDecay: 0.036 },
        { kickDecay: 0.36, snareDecay: 0.17, hihatFreq: 130, hihatDecay: 0.038 }
    ];

    const state = {
        isPlaying: false,
        timeOffset: 0, 
        currentSeed: 0,
        trackStartTime: 0,
        trackDuration: 0,
        
        style: 'Classic',
        mood: 'Chill',
        key: 'C',
        mode: 'Minor',
        scale: [],
        progression: [],
        bpm: 75,
        barCount: 0,
        section: 'Verse',
        
        // HIT SONG VARIABLES
        trackMotif: [],
        drumPattern: [],
        bassPattern: [],   // 0=rest, 1=root, 2=fifth, 3=root up
        hihatPattern: [],  // 0=rest, 1=closed, 2=ghost, 3=open
        useSeventh: false, // 7th chords for Jazzy/Funk
        lastChordVoicing: null,
        activeLeadNote: null,
        params: { swing: 0.04, drumDensity: 0.5 }
    };

    // Nodes
    let radioGroup, stopClick; 
    let keys, pad, bass, lead, kick, snare, hihat, foley;
    let masterFilter, chorus, delay, reverb, bitCrusher, compressor, limiter;
    let vinylNoise, rainNoise, windNoise, filterLFO, padVolumeLFO, analyser;
    let autoPanner, tremolo, vibrato;
    let pageVisible = true;
    let keepAliveAudio = null;
    let wakeLock = null;

    /**
     * Create a 1-second silent WAV blob.
     * Playing this on loop via <audio> does two critical things:
     * 1) Switches iOS from "ambient" to "playback" audio category → bypasses hardware mute switch
     * 2) Keeps the browser audio session alive when screen locks or app goes to background
     */
    function createSilentAudio() {
        const sampleRate = 8000;
        const numSamples = sampleRate; // 1 second of silence
        const buffer = new ArrayBuffer(44 + numSamples * 2);
        const view = new DataView(buffer);
        const w = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
        w(0, 'RIFF');
        view.setUint32(4, 36 + numSamples * 2, true);
        w(8, 'WAVE');
        w(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);   // PCM
        view.setUint16(22, 1, true);   // mono
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);  // 16-bit
        w(36, 'data');
        view.setUint32(40, numSamples * 2, true);
        // All sample bytes default to 0 (silence)
        return new Blob([buffer], { type: 'audio/wav' });
    }

    /** Request screen wake lock (re-acquirable) */
    async function requestWakeLock() {
        if (!('wakeLock' in navigator)) return;
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => { wakeLock = null; });
        } catch (e) {}
    }

    /** Aggressively resume all audio when returning to the page */
    function resumeAllAudio() {
        if (!state.isPlaying) return;
        // Resume AudioContext
        const ctx = Tone.context.rawContext || (Tone.getContext && Tone.getContext().rawContext);
        if (ctx && ctx.state === 'suspended') {
            ctx.resume().then(() => {
                Tone.Transport.start();
                try { vinylNoise.start(); } catch(e) {}
                try { rainNoise.start(); } catch(e) {}
                try { windNoise.start(); } catch(e) {}
                if (padVolumeLFO) try { padVolumeLFO.start(); } catch(e) {}
            }).catch(() => {});
        }
        // Resume keep-alive audio element (iOS/Android background)
        if (keepAliveAudio && keepAliveAudio.paused) {
            keepAliveAudio.play().catch(() => {});
        }
        // Re-acquire wake lock
        if (!wakeLock) requestWakeLock();
    }

    /** Set up all visibility/focus handlers to keep audio alive across mobile lifecycle events */
    function setupVisibilityHandling() {
        pageVisible = document.visibilityState === 'visible';

        // Primary: visibilitychange (tab switch, screen lock/unlock)
        document.addEventListener('visibilitychange', () => {
            pageVisible = document.visibilityState === 'visible';
            if (pageVisible) resumeAllAudio();
        });

        // Secondary: page focus/blur (some Android browsers)
        window.addEventListener('focus', () => { pageVisible = true; resumeAllAudio(); });
        window.addEventListener('blur', () => { pageVisible = false; });

        // Tertiary: resume on any user interaction after return
        const addResumeListeners = () => {
            const handler = () => {
                resumeAllAudio();
                document.removeEventListener('click', handler);
                document.removeEventListener('touchstart', handler);
                // Re-add after a delay so it catches future returns
                setTimeout(addResumeListeners, 1000);
            };
            document.addEventListener('click', handler, { once: true });
            document.addEventListener('touchstart', handler, { once: true });
        };
        addResumeListeners();

        // iOS-specific: pageshow event fires when returning via back/forward cache
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) resumeAllAudio();
        });
    }

    /** Media Session API: lock screen controls & metadata */
    function setupMediaSession() {
        if (!('mediaSession' in navigator)) return;
        navigator.mediaSession.setActionHandler('play', () => { if (!state.isPlaying) togglePlay(); });
        navigator.mediaSession.setActionHandler('pause', () => { if (state.isPlaying) togglePlay(); });
        navigator.mediaSession.setActionHandler('nexttrack', () => {
            if (!radioGroup) return;
            const now = Date.now() + state.timeOffset;
            const timeRemaining = (state.trackStartTime + state.trackDuration) - now;
            state.timeOffset += (timeRemaining + 100);
            updateAudioLogic();
        });
        // No previoustrack — this is a radio, can't go back
        navigator.mediaSession.setActionHandler('previoustrack', null);
        navigator.mediaSession.playbackState = 'playing';
    }

    function updateMediaSessionMetadata(title, artist) {
        if (!('mediaSession' in navigator)) return;
        navigator.mediaSession.metadata = new MediaMetadata({
            title: title,
            artist: artist,
            album: 'Lofi.fm Radio'
        });
    }

    // --- INIT ---
    async function initAudio() {
        if(isInitializing) return;
        isInitializing = true;

        await Tone.start();
        Tone.context.latencyHint = 'playback';
        // Reduce fragmentation when tab is in background (e.g. car): use a slightly larger buffer
        if (Tone.context.rawContext && Tone.context.rawContext.baseLatency) {
            try { Tone.context.rawContext.latencyHint = 'playback'; } catch (e) {}
        }

        // Start silent audio loop — this is critical for mobile:
        // 1) iOS: switches audio category from "ambient" to "playback" → sound plays even when mute switch is on
        // 2) iOS/Android: keeps the browser audio session alive when screen locks or app backgrounds
        if (!keepAliveAudio) {
            keepAliveAudio = new Audio();
            keepAliveAudio.loop = true;
            keepAliveAudio.setAttribute('playsinline', '');
            keepAliveAudio.setAttribute('webkit-playsinline', '');
            keepAliveAudio.src = URL.createObjectURL(createSilentAudio());
        }
        keepAliveAudio.play().catch(() => {});
        
        radioGroup = new Tone.Gain(1).toDestination();
        
        stopClick = new Tone.MembraneSynth({
            pitchDecay: 0.008,
            octaves: 4,
            oscillator: { type: "square4" },
            envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
        }).toDestination();
        stopClick.volume.value = -20;

        limiter = new Tone.Limiter(-1).connect(radioGroup); 
        compressor = new Tone.Compressor(-12, 3).connect(limiter);
        masterFilter = new Tone.Filter(1000, "lowpass").connect(compressor);
        filterLFO = new Tone.LFO(0.05, 400, 1200).start();
        filterLFO.connect(masterFilter.frequency);
        
        reverb = new Tone.JCReverb(0.3).connect(masterFilter);
        delay = new Tone.PingPongDelay("8n", 0.1).connect(reverb);
        chorus = new Tone.Chorus(2, 2.5, 0.5).connect(delay).start(); 
        bitCrusher = new Tone.BitCrusher(8).connect(chorus);

        autoPanner = new Tone.AutoPanner("1m").start().connect(delay); // Very slow panning — gentle stereo width
        tremolo = new Tone.Tremolo(1.5, 0.15).start().connect(bitCrusher); // Slow, subtle amplitude shimmer
        vibrato = new Tone.Vibrato(2, 0.03).connect(autoPanner); // Gentle pitch warmth, not wobble

        keys = new Tone.PolySynth(Tone.Synth, { volume: -24, oscillator: { type: "fatsine" }, envelope: { attack: 0.1, decay: 0.3, sustain: 0.28, release: 0.8 } }).connect(tremolo);
        pad = new Tone.PolySynth(Tone.Synth, { volume: -28, oscillator: { type: "sine" }, envelope: { attack: 1.2, decay: 0.8, sustain: 0.35, release: 1.6 } }).connect(reverb);
        padVolumeLFO = new Tone.LFO(0.06, -34, -26).start(); // Pad stays quiet — background warmth only
        padVolumeLFO.connect(pad.volume);

        bass = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.9, release: 1 }, volume: -12 }).connect(compressor); 
        lead = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.12, release: 0.7 }, volume: -32 }).connect(vibrato); 

        kick = new Tone.MembraneSynth({ volume: -10 }).connect(compressor);
        snare = new Tone.NoiseSynth({ volume: -12, envelope: { decay: 0.15 } }).connect(masterFilter); 
        hihat = new Tone.MetalSynth({ volume: -24, frequency: 140, envelope: { decay: 0.04 } }).connect(reverb);
        
        // Foley Layer (Bird chirps, tape clicks etc.)
        foley = new Tone.Player("https://tonejs.github.io/audio/berklee/gong_1.mp3").connect(reverb); // Placeholder URL, in real app use generated noise bursts
        // Using a noise synth for foley instead to be self-contained
        foley = new Tone.NoiseSynth({ volume: -35, envelope: { attack: 0.02, decay: 0.08 } }).connect(reverb);

        const noiseGain = new Tone.Gain(1).connect(radioGroup);
        vinylNoise = new Tone.Noise("brown").start(); 
        vinylNoise.connect(new Tone.Filter(500, "highpass").connect(noiseGain));
        vinylNoise.volume.value = -45; 
        
        rainNoise = new Tone.Noise("pink").start(); 
        rainNoise.connect(new Tone.AutoFilter("0.1hz").connect(noiseGain));
        rainNoise.volume.value = -99; 

        windNoise = new Tone.Noise("white").start(); 
        const windFilter = new Tone.Filter(800, "bandpass").connect(noiseGain);
        windNoise.connect(windFilter);
        windNoise.volume.value = -99;

        analyser = new Tone.Analyser("fft", 64);
        masterFilter.connect(analyser);

        // Request wake lock (re-acquirable on visibility change)
        await requestWakeLock();
        
        // Keep AudioContext running when tab is in background (prevents car/phone fragmentation)
        setupVisibilityHandling();

        state.isPlaying = true;
        isInitializing = false;
        
        const trackInfo = getCurrentTrackInfo();
        state.currentSeed = trackInfo.seed;
        state.trackStartTime = trackInfo.startTime;
        state.trackDuration = trackInfo.duration;
        
        generateNewTrack(state.currentSeed);
        updateQueueUI();
        
        startSequencer();
        drawVisualizer();
        
        // Set up lock screen controls (play/pause/skip)
        setupMediaSession();
        
        setInterval(updateAudioLogic, 1000); 
        setInterval(updateUIProgress, 200); 
        updatePlayButtonUI(true);
    }

    // Mix time-based pointer into a more varied seed so consecutive tracks don't sound alike
    function diversifySeed(pointer) {
        const p = Math.floor(pointer);
        return ((p * 2654435761) >>> 0) + (p % 86400000);
    }

    // --- ENGINE ---
    function getCurrentTrackInfo() {
        const now = Date.now() + state.timeOffset;
        const currentHour = Math.floor(now / 3600000); 
        
        let pointer = currentHour * 3600000;
        let trackSeed = 0;
        let duration = 0;

        while (pointer < now + MAX_TRACK_MS) {
            const seedForDuration = diversifySeed(pointer);
            const trackRng = mulberry32(seedForDuration);
            duration = MIN_TRACK_MS + Math.floor(trackRng() * (MAX_TRACK_MS - MIN_TRACK_MS));
            
            if (pointer + duration > now) {
                trackSeed = seedForDuration;
                return { seed: trackSeed, startTime: pointer, duration: duration };
            }
            pointer += duration;
        }
    }

    function updateAudioLogic() {
        if (!state.isPlaying) return;
        
        const now = Date.now() + state.timeOffset;
        const timeRemaining = (state.trackStartTime + state.trackDuration) - now;

        if (timeRemaining < 5000 && !isTransitioning) {
            isTransitioning = true;
            radioGroup.gain.rampTo(0, 4); 
            if(filterLFO) { filterLFO.max = 200; filterLFO.frequency.rampTo(0.1, 4); }
            fadeUIText(false);
        }

        if (timeRemaining <= 0) {
            const nextTrack = getCurrentTrackInfo();
            state.currentSeed = nextTrack.seed;
            state.trackStartTime = nextTrack.startTime;
            state.trackDuration = nextTrack.duration;
            
            generateNewTrack(state.currentSeed);
            updateQueueUI();
            
            radioGroup.gain.rampTo(1, 4);
            fadeUIText(true);
            isTransitioning = false;
        }
    }

    function fadeUIText(fadeIn) {
        const opacity = fadeIn ? '1' : '0';
        document.getElementById('playlist-title').style.opacity = opacity;
        const artistEl = document.getElementById('playlist-artist');
        if(artistEl) artistEl.style.opacity = opacity;
        document.getElementById('bar-artist').style.opacity = opacity;
        document.getElementById('bar-title').style.opacity = opacity;
    }

    function generateNewTrack(seed) {
        currentRNG = mulberry32(seed);

        const moods = ['Chill', 'Uplifting', 'Groovy', 'Dreamy', 'Warm']; 
        state.mood = moods[Math.floor(currentRNG() * moods.length)];

        const styleKeys = Object.keys(STYLES);
        state.style = styleKeys[Math.floor(currentRNG() * styleKeys.length)];
        const config = STYLES[state.style];

        state.key = NOTES[Math.floor(currentRNG() * NOTES.length)];
        const availableModes = MOOD_SCALES[state.mood];
        state.mode = availableModes[Math.floor(currentRNG() * availableModes.length)];
        state.scale = generateScale(state.key, state.mode);
        state.progression = generateProgression(state.mode);
        
        let bpm = config.bpmRange[0] + Math.floor(currentRNG() * (config.bpmRange[1] - config.bpmRange[0]));
        if (state.mood === 'Uplifting' || state.mood === 'Groovy' || state.mood === 'Dreamy') bpm += 3;
        state.bpm = Math.max(50, Math.min(110, bpm));
        
        Tone.Transport.bpm.value = state.bpm; 

        state.params.swing = config.swing;
        state.params.drumDensity = config.drumDensity;
        
        // 1. Drum: only iconic hit patterns (style can narrow pool)
        const drumKeys = Object.keys(DRUM_LOOPS);
        const drumKey = drumKeys[Math.floor(currentRNG() * drumKeys.length)];
        state.drumPattern = [...DRUM_LOOPS[drumKey]];
        
        // 2. Motif from famous hook contours (scale degrees -> notes)
        const contour = MOTIF_CONTOURS[Math.floor(currentRNG() * MOTIF_CONTOURS.length)];
        const baseOctave = 4;
        state.trackMotif = contour.map((deg, i) => {
            const idx = Math.max(0, Math.min(deg, 6)) % 7;
            const octave = baseOctave + (deg >= 4 && currentRNG() > 0.5 ? 1 : 0);
            return state.scale[idx] + octave;
        });

        // 3. Bass: only famous patterns
        const bassKeys = Object.keys(BASS_PATTERNS);
        const bassKey = bassKeys[Math.floor(currentRNG() * bassKeys.length)];
        state.bassPattern = [...BASS_PATTERNS[bassKey]];

        // 4. Hi-hat: groove pattern with ghost notes and open hats
        const hhKeys = Object.keys(HIHAT_PATTERNS);
        const hhKey = hhKeys[Math.floor(currentRNG() * hhKeys.length)];
        state.hihatPattern = [...HIHAT_PATTERNS[hhKey]];
        
        state.useSeventh = (state.style === 'Jazzy' || state.style === 'Neo-Soul' || state.style === 'Vintage' || state.style === 'Chill Hop');
        state.lastChordVoicing = null;

        // --- 10x SOUND VARIATION: pick lofi hit patches per track
        const keyIdx = Math.floor(currentRNG() * KEY_PATCHES.length);
        const padIdx = Math.floor(currentRNG() * PAD_PATCHES.length);
        const bassIdx = Math.floor(currentRNG() * BASS_PATCHES.length);
        const leadIdx = Math.floor(currentRNG() * LEAD_PATCHES.length);
        const effectIdx = Math.floor(currentRNG() * EFFECT_PRESETS.length);
        const drumIdx = Math.floor(currentRNG() * DRUM_TONES.length);
        keys.set(KEY_PATCHES[keyIdx]);
        pad.set(PAD_PATCHES[padIdx]);
        bass.set(BASS_PATCHES[bassIdx]);
        lead.set(LEAD_PATCHES[leadIdx]);
        const ep = EFFECT_PRESETS[effectIdx];
        if (reverb.roomSize !== undefined) reverb.roomSize = ep.reverbDecay;
        if (delay.wet) delay.wet.value = ep.delayWet;
        chorus.wet.value = ep.chorusWet;
        if (filterLFO) { filterLFO.min = ep.filterMin; filterLFO.max = ep.filterMax; }
        tremolo.wet.value = ep.tremoloWet;
        if (vibrato.wet) vibrato.wet.value = ep.vibratoWet;
        else if (vibrato.depth) vibrato.depth.value = ep.vibratoWet;
        const dt = DRUM_TONES[drumIdx];
        if (kick.envelope) kick.envelope.decay = dt.kickDecay;
        if (snare.envelope) snare.envelope.decay = dt.snareDecay;
        if (hihat.frequency) hihat.frequency.value = dt.hihatFreq;
        if (hihat.envelope) hihat.envelope.decay = dt.hihatDecay;

        bitCrusher.wet.value = 0.12; // Subtle lo-fi texture, not digital harshness
        bitCrusher.bits.value = Math.max(config.bitCrush || 8, 6); 
        tremolo.wet.value = Math.min(tremolo.wet.value, 0.08); // Cap tremolo — no audible wobble
        if (vibrato.wet) vibrato.wet.value = Math.min(vibrato.wet.value, 0.04);
        
        if (filterLFO) {
            filterLFO.min = Math.max(filterLFO.min, 600); // Keep filter open for clarity
            filterLFO.max = Math.min(3000, filterLFO.max + 300); 
        }

        const vinylLvl = -42 - currentRNG() * 5; 
        vinylNoise.volume.rampTo(vinylLvl, 2);
        
        let rainLvl = -99;
        let windLvl = -99;
        if (state.style === 'Rainy' || state.style === 'Cozy') rainLvl = -36;
        if (state.style === 'Sleepy') { rainLvl = -40; windLvl = -48; }
        if (state.mood === 'Uplifting' || state.mood === 'Dreamy') windLvl = -42;

        rainNoise.volume.rampTo(rainLvl, 1);
        windNoise.volume.rampTo(windLvl, 1);

        const meta = generateMetadata(seed);

        // Update lock screen "Now Playing" info
        updateMediaSessionMetadata(meta.title, meta.artist);
        
        setTimeout(() => {
            document.getElementById('playlist-title').innerText = meta.title;
            const artistEl = document.getElementById('playlist-artist');
            if(artistEl) { artistEl.innerText = meta.artist; artistEl.style.display = 'block'; }
            document.getElementById('bar-title').innerText = meta.title;
            document.getElementById('bar-artist').innerText = meta.artist;
            document.getElementById('style-badge').innerText = state.style;
            document.getElementById('mood-badge').innerText = state.mood; 
            document.getElementById('bpm-badge').innerText = `${state.bpm} BPM`;
            
            let color = config.color;
            if(state.mood === 'Uplifting') color = '#10b981'; 
            if(state.mood === 'Groovy') color = '#d946ef';
            if(state.mood === 'Dreamy') color = '#60a5fa';
            if(state.mood === 'Warm') color = '#f59e0b';
            document.documentElement.style.setProperty('--dynamic-color', color);
        }, 1000); 

        state.barCount = 0;
        state.section = 'Intro';
    }

    function generateMetadata(seed) {
        let rng = mulberry32(seed);
        const titleA = TITLES_A[Math.floor(rng() * TITLES_A.length)];
        const titleB = TITLES_B[Math.floor(rng() * TITLES_B.length)];
        const artistA = ARTISTS_A[Math.floor(rng() * ARTISTS_A.length)];
        const artistB = ARTISTS_B[Math.floor(rng() * ARTISTS_B.length)];
        return { title: `${titleA} ${titleB}`, artist: `${artistA} ${artistB}` };
    }

    function updateQueueUI() {
        const queueContainer = document.getElementById('queue-container');
        queueContainer.innerHTML = '';
        const header = document.createElement('div');
        header.className = 'queue-header';
        header.textContent = 'Next songs';
        queueContainer.appendChild(header);
        
        let pointer = state.trackStartTime; 
        let trackRng, dur, seed;

        seed = diversifySeed(pointer);
        trackRng = mulberry32(seed);
        let currentDur = MIN_TRACK_MS + Math.floor(trackRng() * (MAX_TRACK_MS - MIN_TRACK_MS));
        pointer += currentDur;

        for (let i = 1; i <= 8; i++) {
            seed = diversifySeed(pointer);
            trackRng = mulberry32(seed);
            dur = MIN_TRACK_MS + Math.floor(trackRng() * (MAX_TRACK_MS - MIN_TRACK_MS));
            
            const nextMeta = generateMetadata(seed);
            const nextStyle = getStyleForSeed(seed);
            addTrackRow(queueContainer, i, nextMeta, nextStyle, false);
            pointer += dur;
        }
    }

    function getStyleForSeed(seed) {
        const styleKeys = Object.keys(STYLES);
        return styleKeys[Math.floor(mulberry32(seed)() * styleKeys.length)];
    }

    function addTrackRow(container, num, meta, styleName, isActive) {
        const div = document.createElement('div');
        div.className = `queue-row ${isActive ? 'active' : ''}`;
        div.innerHTML = `
            <div class="q-num">${isActive ? '▶' : num}</div>
            <div class="q-info">
                <div class="q-title">${meta.title}</div>
                <div class="q-artist">${meta.artist}</div>
            </div>
            <div class="q-meta">${styleName}</div>
            <div class="q-meta"></div>
        `;
        container.appendChild(div);
    }

    function generateScale(root, modeName) {
        const rootIdx = NOTES.indexOf(root);
        const intervals = MODES[modeName];
        return intervals.map(i => NOTES[(rootIdx + i) % 12]);
    }
    
    function getChord(degree, scale, octave = 3, addSeventh = false) {
        const r = (degree - 1 + 7) % 7;
        const t = (r + 2) % 7;
        const f = (r + 4) % 7;
        const chord = [scale[r] + octave, scale[t] + octave, scale[f] + octave];
        if (addSeventh) {
            const s = (r + 6) % 7;
            chord.push(scale[s] + octave);
        }
        return chord;
    }

    // Voice leading: pick the chord inversion closest to the previous chord's register
    function voiceLead(chordNotes, prevChord) {
        if (!prevChord || !prevChord.length) return chordNotes;
        try {
            const midiNotes = chordNotes.map(n => Tone.Frequency(n).toMidi());
            const prevCenter = prevChord.reduce((s, n) => s + Tone.Frequency(n).toMidi(), 0) / prevChord.length;
            let best = chordNotes;
            let bestDist = Infinity;
            for (let inv = 0; inv < chordNotes.length; inv++) {
                const voicingMidi = midiNotes.map((m, i) => i < inv ? m + 12 : m);
                voicingMidi.sort((a, b) => a - b);
                const center = voicingMidi.reduce((s, m) => s + m, 0) / voicingMidi.length;
                const dist = Math.abs(center - prevCenter);
                if (dist < bestDist) {
                    bestDist = dist;
                    best = voicingMidi.map(m => Tone.Frequency(m, "midi").toNote());
                }
            }
            return best;
        } catch(e) { return chordNotes; }
    }
    
    function generateProgression(mode) {
        const isMajor = mode === 'Major' || mode === 'Lydian' || mode === 'Mixolydian';
        const pool = isMajor ? FAMOUS_PROGRESSIONS.major : FAMOUS_PROGRESSIONS.minor;
        if (mode === 'Mixolydian') {
            const mixo = [[1, 7, 4, 1], [1, 4, 1, 7], [1, 4, 7, 1]];
            return mixo[Math.floor(currentRNG() * mixo.length)];
        }
        return pool[Math.floor(currentRNG() * pool.length)];
    }
    
    function startSequencer() {
        Tone.Transport.cancel();
        Tone.Transport.start("+0.1");
        let step = 0;
        // Seeded RNG for deterministic sequencer behavior (no more Math.random())
        let seqRNG = mulberry32(state.currentSeed + 77777);

        Tone.Transport.scheduleRepeat((time) => {
            const patIdx = step % 16;
            const sixteenth = step % 4;
            const config = STYLES[state.style];

            // Humanized timing: swing + subtle micro-timing variation
            const swingOffset = state.params.swing * (sixteenth % 2 === 1 ? 1 : 0);
            const humanize = (seqRNG() - 0.5) * 0.005;
            const t = time + swingOffset + humanize;

            // Section awareness for layering
            const isIntro = state.section === 'Intro';
            const isVerse = state.section === 'Verse';
            const isChorus = state.section === 'Chorus';
            const isBreakdown = state.section === 'Breakdown';

            // Current chord with voice leading for smooth transitions
            const progIdx = state.barCount % 4;
            const degree = state.progression[progIdx];
            const rawNotes = getChord(degree, state.scale, 3, state.useSeventh);
            const notes = voiceLead(rawNotes, state.lastChordVoicing);
            const bassRoot = state.scale[(degree - 1 + 7) % 7] + 2;
            const bassFifth = state.scale[(degree + 3) % 7] + 2;
            const bassRootUp = state.scale[(degree - 1 + 7) % 7] + 3;

            // ─── HARMONY (Keys/Chords) — short staccato chords for hip-hop feel ───
            if (step % 16 === 0) {
                const chordVel = 0.15 + seqRNG() * 0.08;
                // Keys: rhythmic stabs, not sustained drones
                if (!isBreakdown) {
                    keys.triggerAttackRelease(notes, "2n", t, chordVel);
                }
                // Pad: very sparse background warmth — NOT on every bar
                if (isIntro) {
                    pad.triggerAttackRelease(notes.slice(0, 3), "1m", t, 0.15);
                } else if (isBreakdown && seqRNG() > 0.3) {
                    pad.triggerAttackRelease(notes.slice(0, 3), "1m", t, 0.12);
                } else if (isChorus && seqRNG() > 0.6) {
                    pad.triggerAttackRelease(notes.slice(0, 3), "2n", t, 0.1);
                }
                // Pad skipped entirely in Verse — let drums and bass breathe
                state.lastChordVoicing = notes;
            }

            // Chord anticipation: rare rhythmic push (5% in chorus only)
            if (step % 16 === 14 && isChorus && seqRNG() < 0.05) {
                const nextDeg = state.progression[(state.barCount + 1) % 4];
                const antNotes = getChord(nextDeg, state.scale, 3, state.useSeventh);
                keys.triggerAttackRelease(antNotes, "8n", t, 0.08);
            }

            // ─── BASS ─── (octave 2 for warmth/audibility, "8n" for sustain)
            if (!isIntro) {
                const bpVal = state.bassPattern[patIdx];
                const bassVel = 0.35 + seqRNG() * 0.12;
                if (bpVal === 1) bass.triggerAttackRelease(bassRoot, "8n", t, bassVel);
                else if (bpVal === 2) bass.triggerAttackRelease(bassFifth, "8n", t, bassVel * 0.9);
                else if (bpVal === 3) bass.triggerAttackRelease(bassRootUp, "8n", t, bassVel * 0.85);
            }

            // ─── LEAD MELODY ─── (barely there — background color, not a melody line)
            if (config.hasLead && !isIntro && !isBreakdown) {
                const leadProb = isChorus ? 0.12 : (isVerse ? 0.03 : 0);
                // Play on half-beats (step % 8) not every beat — more space, less machine
                if (leadProb > 0 && seqRNG() < leadProb && step % 8 === 0) {
                    const motifIdx = (Math.floor(step / 8) + state.barCount) % (state.trackMotif.length || 8);
                    if (state.trackMotif[motifIdx]) {
                        const leadVel = isChorus ? (0.1 + seqRNG() * 0.06) : (0.06 + seqRNG() * 0.04);
                        lead.triggerAttackRelease(state.trackMotif[motifIdx], "8n", t, leadVel);
                    }
                }
            }

            // ─── DRUMS ───
            if (!isIntro && !isBreakdown) {
                // Kick with velocity humanization
                if (state.drumPattern[patIdx] === 1) {
                    const kickVel = 0.65 + seqRNG() * 0.2;
                    kick.triggerAttackRelease("C1", "8n", t, kickVel);
                }
                // Snare with velocity humanization
                if (state.drumPattern[patIdx] === 2) {
                    const snareVel = 0.55 + seqRNG() * 0.2;
                    snare.triggerAttackRelease("16n", t, snareVel);
                }
                // Ghost snare: very rare soft accent (max 3% — drums stay tight)
                if (state.drumPattern[patIdx] === 0 && sixteenth === 2 && seqRNG() < 0.03) {
                    snare.triggerAttackRelease("32n", t, 0.06 + seqRNG() * 0.04);
                }

                // Hi-hat: pattern-based with velocity humanization
                const hhVal = state.hihatPattern[patIdx];
                if (hhVal === 1) {
                    hihat.triggerAttackRelease("32n", t, 0.13 + seqRNG() * 0.08);
                } else if (hhVal === 2) { // Ghost hit — barely audible texture
                    hihat.triggerAttackRelease("32n", t, 0.04 + seqRNG() * 0.04);
                } else if (hhVal === 3) { // Open hat — longer ring
                    hihat.triggerAttackRelease("16n", t, 0.18 + seqRNG() * 0.08);
                }
            } else if (isIntro) {
                // Intro: very sparse hi-hat to gently establish pulse
                if (step % 8 === 0 && seqRNG() < 0.5) {
                    hihat.triggerAttackRelease("32n", t, 0.05 + seqRNG() * 0.03);
                }
            } else if (isBreakdown) {
                // Breakdown: sparse atmospheric pulse
                if (step % 8 === 0 && seqRNG() < 0.35) {
                    hihat.triggerAttackRelease("32n", t, 0.04 + seqRNG() * 0.03);
                }
            }

            // Foley texture (deterministic occasional)
            if (seqRNG() < 0.003) foley.triggerAttackRelease("32n", t, 0.12);

            step = (step + 1) % 16;
            if (step === 0) {
                state.barCount++;
                // Song structure: Intro(4 bars) → [Verse(4) → Chorus(8) → Breakdown(4)] cycle
                if (state.barCount < 4) {
                    state.section = 'Intro';
                } else {
                    const cycleBar = (state.barCount - 4) % 16;
                    if (cycleBar < 4) state.section = 'Verse';
                    else if (cycleBar < 12) state.section = 'Chorus';
                    else state.section = 'Breakdown';
                }
            }
        }, "16n");
    }

    function updateUIProgress() {
        if (!state.isPlaying) return;
        const now = Date.now() + state.timeOffset;
        const elapsed = now - state.trackStartTime;
        const duration = state.trackDuration;
        let percent = (elapsed / duration) * 100;
        percent = Math.max(0, Math.min(100, percent)); 
        document.getElementById('progress-bar').style.width = percent + '%';
        const mcBar = document.getElementById('mobile-progress-bar');
        if (mcBar) mcBar.style.width = percent + '%';
        const s = Math.floor(elapsed / 1000);
        const totalS = Math.floor(duration / 1000);
        const m = Math.floor(s/60);
        const sec = (s%60).toString().padStart(2,'0');
        const timeStr = `${m}:${sec}`;
        document.getElementById('time-current').innerText = timeStr;
        const mcCur = document.getElementById('mobile-time-current');
        if (mcCur) mcCur.innerText = timeStr;
        const totalM = Math.floor(totalS/60);
        const totalSec = (totalS%60).toString().padStart(2,'0');
        const totalStr = `${totalM}:${totalSec}`;
        document.getElementById('time-total').innerText = totalStr;
        const mcTot = document.getElementById('mobile-time-total');
        if (mcTot) mcTot.innerText = totalStr;
    }

    function updatePlayButtonUI(playing) {
        const heroPlay = document.querySelector('#playBtn .icon-play');
        const heroPause = document.querySelector('#playBtn .icon-pause');
        if(heroPlay && heroPause) {
            heroPlay.style.display = playing ? 'none' : 'block';
            heroPause.style.display = playing ? 'block' : 'none';
        }
        const barPlay = document.querySelector('#barPlayBtn .icon-play');
        const barPause = document.querySelector('#barPlayBtn .icon-pause');
        if(barPlay && barPause) {
            barPlay.style.display = playing ? 'none' : 'block';
            barPause.style.display = playing ? 'block' : 'none';
        }
        const prompt = document.getElementById('play-prompt');
        if(prompt) prompt.style.display = playing ? 'none' : 'inline';
    }

    async function togglePlay() {
        if(isInitializing) return;
        
        if(!radioGroup) {
            await initAudio();
            return;
        }

        if(state.isPlaying) {
            state.isPlaying = false;
            updatePlayButtonUI(false);
            stopClick.triggerAttackRelease("C2", "8n");
            radioGroup.gain.rampTo(0, 0.2); 
            setTimeout(() => {
                Tone.Transport.pause();
                vinylNoise.stop(); rainNoise.stop(); windNoise.stop();
                if(padVolumeLFO) padVolumeLFO.stop();
                keys.releaseAll(); pad.releaseAll(); 
            }, 250);
            // Pause keep-alive audio & update lock screen state
            if (keepAliveAudio) keepAliveAudio.pause();
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'paused';
        } else {
            if(Tone.context.state !== 'running') await Tone.start();
            radioGroup.gain.value = 1; 
            state.isPlaying = true;
            Tone.Transport.start();
            vinylNoise.start(); rainNoise.start(); windNoise.start();
            if(padVolumeLFO) padVolumeLFO.start();
            // Resume keep-alive audio & update lock screen state
            if (keepAliveAudio) keepAliveAudio.play().catch(() => {});
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
            updatePlayButtonUI(true);
            drawVisualizer();
        }
    }

    function drawVisualizer() {
        if (!state.isPlaying) return;
        requestAnimationFrame(drawVisualizer);
        // Pause visualizer when tab hidden to save CPU and reduce audio fragmentation (e.g. in car)
        if (!pageVisible || document.visibilityState === 'hidden') return;
        const bufferLength = analyser.getValue().length;
        const dataArray = analyser.getValue(); 
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        const barWidth = (w / bufferLength) * 2;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
            const val = dataArray[i] + 140; 
            const barHeight = Math.max(0, val * 2.5); 
            ctx.fillStyle = `rgba(255, 255, 255, 0.3)`;
            ctx.beginPath();
            ctx.roundRect(x, h/2 - barHeight/2, barWidth, barHeight, 50);
            ctx.fill();
            x += barWidth + 2;
        }
    }

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    
    if(window.innerWidth <= 900) {
        document.querySelector('.mobile-vibes-list').style.display = 'flex';
    }

    document.getElementById('playBtn').addEventListener('click', () => { if(Tone.Transport.state === 'started' || radioGroup) togglePlay(); else initAudio(); });
    document.getElementById('barPlayBtn').addEventListener('click', () => { if(Tone.Transport.state === 'started' || radioGroup) togglePlay(); else initAudio(); });
    
    document.getElementById('nextBtn').addEventListener('click', () => { 
        if(!radioGroup) return; 
        const now = Date.now() + state.timeOffset;
        const timeRemaining = (state.trackStartTime + state.trackDuration) - now;
        state.timeOffset += (timeRemaining + 100); 
        updateAudioLogic();
    });

</script>
</body>
</html>